(()=>{"use strict";function t(t,e={}){if(!t)return;const{block:s="start",delay:a=50}=e;setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:s})},a)}function e(e){t(e,{block:"start"})}function s(e){t(e,{block:"center",delay:100})}const a={head:"default",hair:"short",body:"tunic",accessory:"none",weapon:"sword",colors:{skin:"#e0ac69",hair:"#3b3024",primary:"#3498db",secondary:"#2980b9"}},i={knight:"sword",wizard:"staff",scout:"bow",bard:"staff",ranger:"daggers"},r={knight:"armor_plate",wizard:"robe",scout:"armor_leather",bard:"robe",ranger:"armor_leather"},n={human:{name:"Human",icon:"üë§",description:"Versatile site administrators who excel through determination and adaptability.",statModifiers:{},flexiblePoints:2,passive:"adaptable",passiveName:"Adaptable",passiveDesc:"+5% XP from all sources"},pixelkin:{name:"Pixelkin",icon:"üßö",description:"Small, fast digital sprites born from optimized code. They dart through data like lightning.",statModifiers:{agility:2,intelligence:1,stamina:-1},flexiblePoints:0,passive:"cache_spirit",passiveName:"Cache Spirit",passiveDesc:"10% chance to dodge damage in runner games"},ironforge:{name:"Ironforge",icon:"üî©",description:"Sturdy beings forged from server infrastructure. They are the backbone of any reliable system.",statModifiers:{stamina:2,strength:1,agility:-1},flexiblePoints:0,passive:"firewall",passiveName:"Firewall",passiveDesc:"+1 starting health in all games"},arcanet:{name:"Arcanet",icon:"üîÆ",description:"Magical entities who weave code like spells. Masters of APIs and arcane frameworks.",statModifiers:{intelligence:2,wisdom:1,strength:-1},flexiblePoints:0,passive:"script_mastery",passiveName:"Script Mastery",passiveDesc:"15% cooldown reduction on abilities"},trickster:{name:"Trickster",icon:"üé≠",description:"Charismatic beings who manipulate social algorithms. They thrive on engagement.",statModifiers:{charisma:2,agility:1,wisdom:-1},flexiblePoints:0,passive:"social_engineering",passiveName:"Social Engineering",passiveDesc:"+20% XP from WordPress hooks (comments, shares)"}},o={knight:{name:"Knight",icon:"üõ°Ô∏è",description:"Defenders of the realm. Knights excel at direct combat and protecting what matters.",primaryStats:["strength","stamina"],weapon:"sword",abilities:[{name:"Shield Wall",desc:"+1 starting health in all games"},{name:"Power Strike",desc:"+15% damage in Hack & Slash"}]},wizard:{name:"Wizard",icon:"ü™Ñ",description:"Masters of arcane code. Wizards turn knowledge into power and experience into mastery.",primaryStats:["intelligence","wisdom"],weapon:"staff",abilities:[{name:"Arcane Knowledge",desc:"+10% XP earned from games"},{name:"Penetrating Spell",desc:"Ignore 1 AC in Boss Rush"}]},scout:{name:"Scout",icon:"üèπ",description:"Swift reconnaissance experts. Scouts move fast and see opportunities others miss.",primaryStats:["agility","intelligence"],weapon:"bow",abilities:[{name:"Quick Reflexes",desc:"+20% double-jump window in Runner"},{name:"Swift Movement",desc:"+1 movement speed in Hack & Slash"}]},bard:{name:"Bard",icon:"üé∏",description:"Storytellers and community builders. Bards inspire others and turn engagement into legend.",primaryStats:["charisma","wisdom"],weapon:"lute",abilities:[{name:"Inspiring Presence",desc:"+25% XP from WordPress hooks"},{name:"Party Buff",desc:"+5% XP for other players on site"}]},ranger:{name:"Ranger",icon:"‚öîÔ∏è",description:"Hunters of dangerous prey. Rangers specialize in taking down the biggest threats.",primaryStats:["strength","agility"],weapon:"dual_blades",abilities:[{name:"Precision Strike",desc:"Expanded crit range (18-20) in Boss Rush"},{name:"Giant Slayer",desc:"+10% damage to boss enemies"}]}},l={strength:{name:"STR",fullName:"Strength",icon:"üí™",color:"#e74c3c"},wisdom:{name:"WIS",fullName:"Wisdom",icon:"üß†",color:"#9b59b6"},charisma:{name:"CHA",fullName:"Charisma",icon:"‚ú®",color:"#f39c12"},stamina:{name:"STA",fullName:"Stamina",icon:"üõ°Ô∏è",color:"#27ae60"},agility:{name:"AGI",fullName:"Agility",icon:"‚ö°",color:"#3498db"},intelligence:{name:"INT",fullName:"Intelligence",icon:"üìö",color:"#1abc9c"}},c={easy:{enemySpeedMult:.7,enemyHpMult:.8,spawnRateMult:1.3,playerHealth:5},normal:{enemySpeedMult:1,enemyHpMult:1,spawnRateMult:1,playerHealth:3},hard:{enemySpeedMult:1.3,enemyHpMult:1.2,spawnRateMult:.7,playerHealth:2}},h={easy:{hpMult:.7,damageMult:.7,acMod:-2,abilityChance:.2},normal:{hpMult:1,damageMult:1,acMod:0,abilityChance:.35},hard:{hpMult:1.3,damageMult:1.3,acMod:2,abilityChance:.5}},d={hackslash:{icon:"‚öîÔ∏è",title:"Hack & Slash",desc:"Battle through waves of enemies to defend your site!",controls:"<strong>Desktop:</strong> Arrow keys/WASD to move, SPACE to attack<br><strong>Mobile:</strong> D-pad to move, sword button to attack"},runner:{icon:"üèÉ",title:"Plugin Dash",desc:"Run, jump, and collect plugins while avoiding bugs!",controls:"<strong>Desktop:</strong> SPACE or UP arrow to jump (double-jump available!)<br><strong>Mobile:</strong> Tap the JUMP button"},bossrush:{icon:"üêâ",title:"Boss Rush",desc:"Face 5 fearsome bosses in D20 turn-based combat!",controls:'<strong>Click "Roll to Attack!"</strong> to roll a D20. Beat the boss AC to hit!'},adventure:{icon:"üìñ",title:"Text Quest",desc:"A choose your own adventure with D20 skill checks!",controls:"<strong>Click choices</strong> to progress the story. Some choices require dice rolls!"}};class u{constructor(t,e){this.container=t,this.characterManager=e,this.currentStep=1,this.totalSteps=5,this.maxRerolls=3,this.rerollsUsed=0,this.selectedRace=null,this.selectedClass=null,this.humanStatChoices=[],this.rolledStats=null,this.avatarData={...a},this.characterName="",this.wizardModal=t.querySelector(".site-rpg-creation-wizard"),this.wizardModal&&this.bindEvents()}show(){this.wizardModal&&(this.reset(),this.isLegacyMode=!1,this.wizardModal.style.display="flex",this.renderStep(),s(this.wizardModal))}showLegacyMode(){this.wizardModal&&(this.reset(),this.isLegacyMode=!0,this.totalSteps=2,this.wizardModal.style.display="flex",this.renderStep(),s(this.wizardModal))}hide(){this.wizardModal&&(this.wizardModal.style.display="none"),this.totalSteps=5,this.isLegacyMode=!1}reset(){this.currentStep=1,this.rerollsUsed=0,this.selectedRace=null,this.selectedClass=null,this.humanStatChoices=[],this.rolledStats=null,this.avatarData={...a},this.characterName="",this.isLegacyMode=!1,this.totalSteps=5}nextStep(){if(this.currentStep<this.totalSteps){if(!this.validateStep())return;this.currentStep++,this.renderStep()}}prevStep(){this.currentStep>1&&(this.currentStep--,this.renderStep())}goToStep(t){t>=1&&t<=this.totalSteps&&(this.currentStep=t,this.renderStep())}validateStep(){switch(this.currentStep){case 1:return this.selectedRace?!("human"===this.selectedRace&&this.humanStatChoices.length<2&&(this.showError("Please choose 2 stats for your Human bonus."),1)):(this.showError("Please select a race."),!1);case 2:return!!this.selectedClass||(this.showError("Please select a class."),!1);case 3:return!!this.rolledStats||(this.showError("Please roll your stats."),!1);case 4:default:return!0;case 5:return!!this.characterName.trim()||(this.showError("Please enter a character name."),!1)}}showError(t){const e=this.wizardModal.querySelector(".site-rpg-wizard__error");e&&(e.textContent=t,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}renderStep(){const t=this.wizardModal.querySelector(".site-rpg-wizard__body");if(t)switch(this.renderStepIndicator(),this.updateNavButtons(),this.currentStep){case 1:t.innerHTML=this.renderRaceSelection(),this.bindRaceEvents();break;case 2:t.innerHTML=this.renderClassSelection(),this.bindClassEvents();break;case 3:t.innerHTML=this.renderStatRolling(),this.bindStatEvents();break;case 4:t.innerHTML=this.renderAvatarCustomization(),this.bindAvatarEvents();break;case 5:t.innerHTML=this.renderConfirmation(),this.bindConfirmEvents()}}renderStepIndicator(){const t=this.wizardModal.querySelector(".site-rpg-wizard__progress");if(!t)return;const e=this.isLegacyMode?["Race","Class"]:["Race","Class","Stats","Avatar","Confirm"];t.innerHTML=e.map((t,e)=>{const s=e+1;let a="site-rpg-wizard__step";return s===this.currentStep&&(a+=" site-rpg-wizard__step--active"),s<this.currentStep&&(a+=" site-rpg-wizard__step--complete"),`<div class="${a}" data-step="${s}">\n\t\t\t\t<span class="site-rpg-wizard__step-num">${s}</span>\n\t\t\t\t<span class="site-rpg-wizard__step-name">${t}</span>\n\t\t\t</div>`}).join("")}updateNavButtons(){const t=this.wizardModal.querySelector(".site-rpg-wizard__btn--prev"),e=this.wizardModal.querySelector(".site-rpg-wizard__btn--next");t&&(t.style.visibility=this.currentStep>1?"visible":"hidden"),e&&(this.currentStep===this.totalSteps?(e.textContent=this.isLegacyMode?"Choose Heritage":"Create Character",e.classList.add("site-rpg-wizard__btn--create")):(e.textContent="Next",e.classList.remove("site-rpg-wizard__btn--create")))}renderRaceSelection(){const t=Object.entries(n).map(([t,e])=>{const s=this.selectedRace===t,a=Object.entries(e.statModifiers||{}).map(([t,e])=>`${l[t]?.name||t} ${e>0?"+":""}${e}`).join(", ")||"+1 to any 2 stats";return`\n\t\t\t\t<div class="site-rpg-wizard__race ${s?"site-rpg-wizard__race--selected":""}" data-race="${t}">\n\t\t\t\t\t<div class="site-rpg-wizard__race-icon">${e.icon}</div>\n\t\t\t\t\t<div class="site-rpg-wizard__race-info">\n\t\t\t\t\t\t<h4 class="site-rpg-wizard__race-name">${e.name}</h4>\n\t\t\t\t\t\t<p class="site-rpg-wizard__race-desc">${e.description}</p>\n\t\t\t\t\t\t<div class="site-rpg-wizard__race-stats">${a}</div>\n\t\t\t\t\t\t<div class="site-rpg-wizard__race-passive">\n\t\t\t\t\t\t\t<strong>${e.passiveName}:</strong> ${e.passiveDesc}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`}).join("");let e="";return"human"===this.selectedRace&&(e=`\n\t\t\t\t<div class="site-rpg-wizard__human-bonus">\n\t\t\t\t\t<h4>Choose 2 Stats for +1 Bonus</h4>\n\t\t\t\t\t<div class="site-rpg-wizard__stat-choices">${Object.entries(l).map(([t,e])=>{const s=this.humanStatChoices.includes(t);return`\n\t\t\t\t\t<button type="button" class="site-rpg-wizard__stat-choice ${s?"site-rpg-wizard__stat-choice--selected":""}"\n\t\t\t\t\t\tdata-stat="${t}" ${this.humanStatChoices.length>=2&&!s?"disabled":""}>\n\t\t\t\t\t\t${e.icon} ${e.name}\n\t\t\t\t\t</button>\n\t\t\t\t`}).join("")}</div>\n\t\t\t\t\t<p class="site-rpg-wizard__human-count">${this.humanStatChoices.length}/2 selected</p>\n\t\t\t\t</div>\n\t\t\t`),`\n\t\t\t<h3 class="site-rpg-wizard__title">Choose Your Race</h3>\n\t\t\t<div class="site-rpg-wizard__error" style="display: none;"></div>\n\t\t\t<div class="site-rpg-wizard__races">${t}</div>\n\t\t\t${e}\n\t\t`}renderClassSelection(){return`\n\t\t\t<h3 class="site-rpg-wizard__title">Choose Your Class</h3>\n\t\t\t<div class="site-rpg-wizard__error" style="display: none;"></div>\n\t\t\t<div class="site-rpg-wizard__classes">${Object.entries(o).map(([t,e])=>{const s=this.selectedClass===t,a=e.primaryStats.map(t=>l[t]?.name||t).join(", ");return`\n\t\t\t\t<div class="site-rpg-wizard__class ${s?"site-rpg-wizard__class--selected":""}" data-class="${t}">\n\t\t\t\t\t<div class="site-rpg-wizard__class-icon">${e.icon}</div>\n\t\t\t\t\t<div class="site-rpg-wizard__class-info">\n\t\t\t\t\t\t<h4 class="site-rpg-wizard__class-name">${e.name}</h4>\n\t\t\t\t\t\t<p class="site-rpg-wizard__class-desc">${e.description}</p>\n\t\t\t\t\t\t<div class="site-rpg-wizard__class-primary">Primary: ${a} (+1 each)</div>\n\t\t\t\t\t\t<div class="site-rpg-wizard__class-abilities">\n\t\t\t\t\t\t\t${e.abilities.map(t=>`<div class="site-rpg-wizard__ability"><strong>${t.name}:</strong> ${t.desc}</div>`).join("")}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`}).join("")}</div>\n\t\t`}renderStatRolling(){let t="";if(this.rolledStats){const e=this.getModifiedStats();t=Object.entries(l).map(([t,s])=>{const a=this.rolledStats[t]||10,i=e[t]||10,r=i-a,n=0!==r?`<span class="site-rpg-wizard__stat-mod ${r>0?"positive":"negative"}">(${r>0?"+":""}${r})</span>`:"";return`\n\t\t\t\t\t<div class="site-rpg-wizard__stat-row">\n\t\t\t\t\t\t<span class="site-rpg-wizard__stat-icon">${s.icon}</span>\n\t\t\t\t\t\t<span class="site-rpg-wizard__stat-name">${s.fullName}</span>\n\t\t\t\t\t\t<span class="site-rpg-wizard__stat-value">${a}${n} = <strong>${i}</strong></span>\n\t\t\t\t\t</div>\n\t\t\t\t`}).join("")}const e=this.rerollsUsed>=this.maxRerolls&&this.rolledStats,s=this.maxRerolls-this.rerollsUsed;return`\n\t\t\t<h3 class="site-rpg-wizard__title">Roll Your Stats</h3>\n\t\t\t<div class="site-rpg-wizard__error" style="display: none;"></div>\n\t\t\t<p class="site-rpg-wizard__subtitle">Click the dice to roll 4d6 (drop lowest) for each stat!</p>\n\n\t\t\t<div class="site-rpg-wizard__dice-container">\n\t\t\t\t<button type="button" class="site-rpg-wizard__roll-btn" ${e?"disabled":""}>\n\t\t\t\t\t<span class="site-rpg-wizard__dice">üé≤</span>\n\t\t\t\t\t${this.rolledStats?"Re-roll":"Roll Stats!"}\n\t\t\t\t</button>\n\t\t\t\t${this.rolledStats?`<p class="site-rpg-wizard__rerolls">${s} re-roll${1!==s?"s":""} remaining</p>`:""}\n\t\t\t</div>\n\n\t\t\t${this.rolledStats?`\n\t\t\t\t<div class="site-rpg-wizard__stats-result">\n\t\t\t\t\t${t}\n\t\t\t\t</div>\n\t\t\t\t<p class="site-rpg-wizard__stats-note">\n\t\t\t\t\tRace modifiers from <strong>${n[this.selectedRace]?.name||"Unknown"}</strong>\n\t\t\t\t\tand class bonuses from <strong>${o[this.selectedClass]?.name||"Unknown"}</strong> are applied.\n\t\t\t\t</p>\n\t\t\t`:""}\n\t\t`}renderAvatarCustomization(){const t=this.renderColorOptions("skin"),e=this.renderColorOptions("hair"),s=this.renderColorOptions("primary"),a=this.renderColorOptions("secondary");return`\n\t\t\t<h3 class="site-rpg-wizard__title">Customize Your Avatar</h3>\n\t\t\t<div class="site-rpg-wizard__error" style="display: none;"></div>\n\n\t\t\t<div class="site-rpg-wizard__avatar-preview">\n\t\t\t\t<div class="site-rpg-wizard__avatar-display" style="background: ${this.avatarData.colors.primary}; border-color: ${this.avatarData.colors.secondary};">\n\t\t\t\t\t<span class="site-rpg-wizard__avatar-icon">${o[this.selectedClass]?.icon||"‚öîÔ∏è"}</span>\n\t\t\t\t</div>\n\t\t\t\t<p class="site-rpg-wizard__avatar-race">${n[this.selectedRace]?.icon} ${n[this.selectedRace]?.name}</p>\n\t\t\t\t<p class="site-rpg-wizard__avatar-class">${o[this.selectedClass]?.icon} ${o[this.selectedClass]?.name}</p>\n\t\t\t</div>\n\n\t\t\t<div class="site-rpg-wizard__avatar-options">\n\t\t\t\t<div class="site-rpg-wizard__color-section">\n\t\t\t\t\t<h4>Skin Tone</h4>\n\t\t\t\t\t<div class="site-rpg-wizard__color-grid" data-color-type="skin">${t}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="site-rpg-wizard__color-section">\n\t\t\t\t\t<h4>Hair Color</h4>\n\t\t\t\t\t<div class="site-rpg-wizard__color-grid" data-color-type="hair">${e}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="site-rpg-wizard__color-section">\n\t\t\t\t\t<h4>Primary Color</h4>\n\t\t\t\t\t<div class="site-rpg-wizard__color-grid" data-color-type="primary">${s}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="site-rpg-wizard__color-section">\n\t\t\t\t\t<h4>Accent Color</h4>\n\t\t\t\t\t<div class="site-rpg-wizard__color-grid" data-color-type="secondary">${a}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderColorOptions(t){const e={skin:[{name:"Fair",value:"#f4c794"},{name:"Light",value:"#e0ac69"},{name:"Medium",value:"#c68642"},{name:"Tan",value:"#8d5524"},{name:"Dark",value:"#6b4423"},{name:"Deep",value:"#4a2c17"}],hair:[{name:"Black",value:"#090806"},{name:"Dark Brown",value:"#2c1608"},{name:"Brown",value:"#3b3024"},{name:"Blonde",value:"#b89778"},{name:"Platinum",value:"#d6c4c2"},{name:"Red",value:"#8b2500"}],primary:[{name:"Red",value:"#e74c3c"},{name:"Blue",value:"#3498db"},{name:"Green",value:"#27ae60"},{name:"Purple",value:"#9b59b6"},{name:"Gold",value:"#f39c12"},{name:"Teal",value:"#1abc9c"}],secondary:[{name:"Dark Red",value:"#c0392b"},{name:"Dark Blue",value:"#2980b9"},{name:"Dark Green",value:"#1e8449"},{name:"Dark Purple",value:"#8e44ad"},{name:"Dark Gold",value:"#d68910"},{name:"Dark Teal",value:"#16a085"}]}[t]||[],s=this.avatarData.colors[t];return e.map(t=>`\n\t\t\t\t<button type="button"\n\t\t\t\t\tclass="site-rpg-wizard__color-swatch ${t.value===s?"site-rpg-wizard__color-swatch--selected":""}"\n\t\t\t\t\tdata-color="${t.value}"\n\t\t\t\t\tstyle="background-color: ${t.value};"\n\t\t\t\t\ttitle="${t.name}">\n\t\t\t\t</button>\n\t\t\t`).join("")}renderConfirmation(){const t=this.getModifiedStats(),e=n[this.selectedRace],s=o[this.selectedClass],a=Object.entries(l).map(([e,s])=>{const a=t[e]||10;return`\n\t\t\t\t<div class="site-rpg-wizard__confirm-stat">\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-stat-icon">${s.icon}</span>\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-stat-name">${s.name}</span>\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-stat-value">${a}</span>\n\t\t\t\t</div>\n\t\t\t`}).join(""),i=window.siteRpgData?.userDisplayName||"Hero";return`\n\t\t\t<h3 class="site-rpg-wizard__title">Create Your Character</h3>\n\t\t\t<div class="site-rpg-wizard__error" style="display: none;"></div>\n\n\t\t\t<div class="site-rpg-wizard__confirm-avatar">\n\t\t\t\t<div class="site-rpg-wizard__avatar-display site-rpg-wizard__avatar-display--large"\n\t\t\t\t\tstyle="background: ${this.avatarData.colors.primary}; border-color: ${this.avatarData.colors.secondary};">\n\t\t\t\t\t<span class="site-rpg-wizard__avatar-icon">${s?.icon||"‚öîÔ∏è"}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="site-rpg-wizard__confirm-name">\n\t\t\t\t<label for="wizard-character-name">Character Name</label>\n\t\t\t\t<input type="text" id="wizard-character-name" class="site-rpg-wizard__name-input"\n\t\t\t\t\tvalue="${this.characterName||i}" placeholder="Enter your name" maxlength="50">\n\t\t\t</div>\n\n\t\t\t<div class="site-rpg-wizard__confirm-info">\n\t\t\t\t<div class="site-rpg-wizard__confirm-row">\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-label">Race:</span>\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-value">${e?.icon} ${e?.name}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="site-rpg-wizard__confirm-row">\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-label">Class:</span>\n\t\t\t\t\t<span class="site-rpg-wizard__confirm-value">${s?.icon} ${s?.name}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="site-rpg-wizard__confirm-stats">\n\t\t\t\t<h4>Final Stats</h4>\n\t\t\t\t<div class="site-rpg-wizard__confirm-stats-grid">${a}</div>\n\t\t\t</div>\n\t\t`}getModifiedStats(){if(!this.rolledStats)return{};const t={...this.rolledStats},e=n[this.selectedRace],s=o[this.selectedClass];if(e){for(const[s,a]of Object.entries(e.statModifiers||{}))t[s]=Math.max(1,Math.min(20,(t[s]||10)+a));if("human"===this.selectedRace)for(const e of this.humanStatChoices)t[e]=Math.min(20,(t[e]||10)+1)}if(s)for(const e of s.primaryStats)t[e]=Math.min(20,(t[e]||10)+1);return t}rollStats(){const t=["strength","wisdom","charisma","stamina","agility","intelligence"],e={};for(const s of t){const t=this.roll4d6DropLowest();e[s]=this.scaleToStatRange(t)}return e}roll4d6DropLowest(){const t=[];for(let e=0;e<4;e++)t.push(Math.floor(6*Math.random())+1);return t.sort((t,e)=>e-t),t[0]+t[1]+t[2]}scaleToStatRange(t){return Math.round((t-3)/15*19+1)}bindEvents(){const t=this.wizardModal.querySelector(".site-rpg-wizard__btn--prev"),e=this.wizardModal.querySelector(".site-rpg-wizard__btn--next"),s=this.wizardModal.querySelector(".site-rpg-wizard__close");t&&t.addEventListener("click",()=>this.prevStep()),e&&e.addEventListener("click",()=>{this.currentStep===this.totalSteps?this.isLegacyMode?this.submitLegacyChoice():this.submitCharacter():this.nextStep()}),s&&s.addEventListener("click",()=>this.hide()),this.wizardModal.addEventListener("click",t=>{t.target===this.wizardModal&&this.hide()})}bindRaceEvents(){this.wizardModal.querySelectorAll(".site-rpg-wizard__race").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.race;this.selectedRace=e,"human"!==e&&(this.humanStatChoices=[]),this.renderStep()})}),this.wizardModal.querySelectorAll(".site-rpg-wizard__stat-choice").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.stat,s=this.humanStatChoices.indexOf(e);s>-1?this.humanStatChoices.splice(s,1):this.humanStatChoices.length<2&&this.humanStatChoices.push(e),this.renderStep()})})}bindClassEvents(){this.wizardModal.querySelectorAll(".site-rpg-wizard__class").forEach(t=>{t.addEventListener("click",()=>{this.selectedClass=t.dataset.class,o[this.selectedClass]&&(this.avatarData.weapon=i[this.selectedClass]||"sword",this.avatarData.body=r[this.selectedClass]||"tunic"),this.renderStep()})})}bindStatEvents(){const t=this.wizardModal.querySelector(".site-rpg-wizard__roll-btn");t&&t.addEventListener("click",()=>{const e=t.querySelector(".site-rpg-wizard__dice");e&&(e.classList.add("site-rpg-wizard__dice--rolling"),setTimeout(()=>e.classList.remove("site-rpg-wizard__dice--rolling"),500)),setTimeout(()=>{this.rolledStats=this.rollStats(),this.rolledStats&&this.rerollsUsed++,this.renderStep()},500)})}bindAvatarEvents(){this.wizardModal.querySelectorAll(".site-rpg-wizard__color-grid").forEach(t=>{const e=t.dataset.colorType;t.querySelectorAll(".site-rpg-wizard__color-swatch").forEach(t=>{t.addEventListener("click",()=>{this.avatarData.colors[e]=t.dataset.color,this.renderStep()})})})}bindConfirmEvents(){const t=this.wizardModal.querySelector(".site-rpg-wizard__name-input");t&&(t.addEventListener("input",t=>{this.characterName=t.target.value}),this.characterName=t.value)}async submitCharacter(){if(!this.validateStep())return;const t=this.wizardModal.querySelector(".site-rpg-wizard__btn--next");t&&(t.disabled=!0,t.textContent="Creating...");try{const t=await fetch(window.siteRpgData.restUrl+"character/create",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce},body:JSON.stringify({race:this.selectedRace,class:this.selectedClass,characterName:this.characterName,avatarData:this.avatarData,humanChoices:this.humanStatChoices,stats:this.rolledStats})}),e=await t.json();e.success&&e.character?(this.characterManager.character=e.character,this.characterManager.updateCharacterDisplay(),this.characterManager.hideCreateCharacterPrompt(),this.hide()):this.showError(e.message||"Failed to create character.")}catch(t){console.error("Character creation failed:",t),this.showError("An error occurred. Please try again.")}finally{t&&(t.disabled=!1,t.textContent="Create Character")}}async submitLegacyChoice(){if(!this.validateStep())return;const t=this.wizardModal.querySelector(".site-rpg-wizard__btn--next");t&&(t.disabled=!0,t.textContent="Saving...");try{await this.characterManager.setRaceClass(this.selectedRace,this.selectedClass)?this.hide():this.showError("Failed to update character. Please try again.")}catch(t){console.error("Legacy choice failed:",t),this.showError("An error occurred. Please try again.")}finally{t&&(t.disabled=!1,t.textContent="Choose Heritage")}}}class p{constructor(t){this.container=t,this.character=window.siteRpgData?.character||null,this.isLoggedIn=window.siteRpgData?.isLoggedIn||!1,this.userId=window.siteRpgData?.userId||0,this.guestStorageKey="site_rpg_guest_character",this.createModal=t.querySelector(".site-rpg-character-create"),this.levelUpModal=t.querySelector(".site-rpg-levelup-modal"),this.claimModal=t.querySelector(".site-rpg-claim-modal"),this.resetModal=t.querySelector(".site-rpg-reset-modal"),this.legacyModal=t.querySelector(".site-rpg-legacy-modal"),this.creationWizard=new u(t,this),this.bindEvents(),this.checkGuestClaim(),this.checkLegacyCharacter(),this.character&&this.updateCharacterDisplay()}checkLegacyCharacter(){this.isLoggedIn&&this.character&&(this.character.race&&this.character.characterClass||this.showLegacyPrompt())}showLegacyPrompt(){const t=this.container.querySelector(".site-rpg-legacy-btn");t&&(t.style.display="inline-flex")}hideLegacyPrompt(){const t=this.container.querySelector(".site-rpg-legacy-btn");t&&(t.style.display="none")}chooseLegacy(){this.isLoggedIn&&this.character&&this.creationWizard&&this.creationWizard.showLegacyMode()}async setRaceClass(t,e){if(!this.isLoggedIn||!this.character)return null;try{const s=await fetch(window.siteRpgData.restUrl+"character/set-race-class",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce},body:JSON.stringify({race:t,character_class:e})}),a=await s.json();if(a.success&&a.character)return this.character=a.character,this.updateCharacterDisplay(),this.hideLegacyPrompt(),this.character}catch(t){console.error("Failed to set race/class:",t)}return null}async checkGuestClaim(){if(!this.isLoggedIn)return;const t=this.getGuestData();t&&t.games_played&&!this.character&&this.claimModal&&this.showClaimModal(t)}getGuestData(){try{const t=localStorage.getItem(this.guestStorageKey);if(t)return JSON.parse(t);const e=localStorage.getItem("site_rpg_rolled_stats");if(e)return{stats:JSON.parse(e).stats,xp:0,level:1,games_played:parseInt(localStorage.getItem("site_rpg_games_played")||"0",10)}}catch(t){return null}return null}saveGuestData(t){localStorage.setItem(this.guestStorageKey,JSON.stringify(t))}clearGuestData(){localStorage.removeItem(this.guestStorageKey),localStorage.removeItem("site_rpg_rolled_stats"),localStorage.removeItem("site_rpg_games_played")}showClaimModal(t){if(!this.claimModal)return;const e=this.claimModal.querySelector(".claim-xp"),a=this.claimModal.querySelector(".claim-games");e&&(e.textContent=t.xp||0),a&&(a.textContent=t.games_played||0),this.claimModal.style.display="flex",s(this.claimModal)}async claimGuestProgress(){const t=this.getGuestData();if(t)try{const e=await fetch(window.siteRpgData.restUrl+"character/claim-guest",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce},body:JSON.stringify({guestData:t})}),s=await e.json();s.success&&s.character&&(this.character=s.character,this.clearGuestData(),this.updateCharacterDisplay(),this.claimModal&&(this.claimModal.style.display="none"))}catch(t){console.error("Failed to claim guest progress:",t)}}createCharacter(){this.isLoggedIn&&this.creationWizard&&this.creationWizard.show()}async createCharacterDirect(){if(!this.isLoggedIn)return null;try{const t=await fetch(window.siteRpgData.restUrl+"character/create",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce}}),e=await t.json();if(e.success&&e.character)return this.character=e.character,this.updateCharacterDisplay(),this.hideCreateCharacterPrompt(),this.character}catch(t){console.error("Failed to create character:",t)}return null}hideCreateCharacterPrompt(){const t=this.container.querySelector(".site-rpg-card__create-character");t&&(t.style.display="none");const e=this.container.querySelector(".site-rpg-reset-character-btn");e&&(e.style.display="inline-flex")}showLevelUpModal(t,e){if(!this.levelUpModal)return;const a=this.levelUpModal.querySelector(".levelup-level"),i=this.levelUpModal.querySelector(".points-count");a&&(a.textContent=t),i&&(i.textContent=e),this.updateStatAllocationButtons(),this.levelUpModal.style.display="flex",s(this.levelUpModal)}hideLevelUpModal(){this.levelUpModal&&(this.levelUpModal.style.display="none")}updateStatAllocationButtons(){if(!this.character||!this.levelUpModal)return;this.levelUpModal.querySelectorAll("[data-allocate-stat]").forEach(t=>{const e=t.dataset.allocateStat,s=this.character.stats[e]||10;t.disabled=s>=20;const a=t.querySelector(".stat-value");a&&(a.textContent=s)});const t=this.levelUpModal.querySelector(".points-count");t&&(t.textContent=this.character.unspentStatPoints||0),this.character.unspentStatPoints<=0&&setTimeout(()=>this.hideLevelUpModal(),1500)}async allocateStat(t){if(this.isLoggedIn&&this.character)try{const e=await fetch(window.siteRpgData.restUrl+"character/allocate-stat",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce},body:JSON.stringify({stat:t})}),s=await e.json();s.success&&s.character&&(this.character=s.character,this.updateCharacterDisplay(),this.updateStatAllocationButtons())}catch(t){console.error("Failed to allocate stat:",t)}}getStats(){return this.character&&this.character.stats?this.character.stats:null}getStatBonuses(){if(this.character&&this.character.statBonuses)return this.character.statBonuses;const t=this.getStats();return t?{str:Math.floor((t.strength-10)/2),wis:Math.floor((t.wisdom-10)/2),cha:Math.floor((t.charisma-10)/2),sta:Math.floor((t.stamina-10)/2),agi:Math.floor((t.agility-10)/2),int:Math.floor((t.intelligence-10)/2)}:null}updateCharacterDisplay(){if(!this.character)return;const t=this.container.querySelector(".site-rpg-card__level-badge");t&&(t.textContent=`Level ${this.character.level}`);const e=this.container.querySelector(".site-rpg-card__level-title");e&&(e.textContent=this.character.levelTitle);const s=this.container.querySelector(".site-rpg-card__race");s&&(this.character.raceName?(s.textContent=this.character.raceName,s.style.display="inline"):(s.textContent="Unknown Heritage",s.style.display="inline"));const a=this.container.querySelector(".site-rpg-card__class");a&&(this.character.className?(a.textContent=this.character.className,a.style.display="inline"):(a.textContent="Adventurer",a.style.display="inline"));const i=this.container.querySelector(".site-rpg-card__avatar-level");i&&(i.textContent=this.character.level);const r=this.container.querySelector(".site-rpg-xp-current");r&&(r.textContent=this.character.xp);const n=this.container.querySelector(".site-rpg-xp-next");n&&(n.textContent=this.character.xpToNextLevel);const o=this.container.querySelector(".site-rpg-card__xp-fill");if(o){const t=this.character.xp/this.character.xpToNextLevel*100;o.style.width=`${Math.min(100,t)}%`}this.container.querySelectorAll(".site-rpg-card__stat").forEach(t=>{const e=t.dataset.stat;if(this.character.stats&&void 0!==this.character.stats[e]){const s=this.character.stats[e];t.dataset.value=s;const a=t.querySelector(".site-rpg-card__stat-value");a&&(a.innerHTML=`${s}<span class="site-rpg-card__stat-max">/20</span>`);const i=t.querySelector(".site-rpg-card__stat-fill");i&&(i.style.width=`${Math.min(5*s,100)}%`)}})}handleGameComplete(t){t.character&&(this.character=t.character,this.updateCharacterDisplay()),t.leveledUp&&this.character&&(this.showLevelUpModal(t.newLevel,this.character.unspentStatPoints),t.newlyUnlockedLevel&&this.container.rewardsManager&&setTimeout(()=>{this.container.rewardsManager.checkLevelCouponUnlock(t.newlyUnlockedLevel,!0)},500))}showResetModal(){if(this.resetModal){if(this.character){const t=this.resetModal.querySelector(".reset-current-level"),e=this.resetModal.querySelector(".reset-current-xp"),s=this.resetModal.querySelector(".reset-current-games");t&&(t.textContent=this.character.level),e&&(e.textContent=this.character.totalXp),s&&(s.textContent=this.character.gamesPlayed)}this.resetModal.style.display="flex",s(this.resetModal)}}hideResetModal(){this.resetModal&&(this.resetModal.style.display="none")}async resetCharacter(){if(this.isLoggedIn&&this.character)try{const t=await fetch(window.siteRpgData.restUrl+"character/reset",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce}}),e=await t.json();e.success&&e.deleted&&(this.character=null,this.hideResetModal(),this.showCreateCharacterPrompt())}catch(t){console.error("Failed to delete character:",t)}}showCreateCharacterPrompt(){const t=this.container.querySelector(".site-rpg-card__create-character");t&&(t.style.display="flex");const e=this.container.querySelector(".site-rpg-reset-character-btn");e&&(e.style.display="none")}bindEvents(){const t=this.container.querySelector('[data-action="create-character"]');t&&t.addEventListener("click",()=>this.createCharacter());const e=this.container.querySelector('[data-action="choose-legacy"]');e&&e.addEventListener("click",()=>this.chooseLegacy());const s=this.container.querySelector('[data-action="claim-guest"]');s&&s.addEventListener("click",()=>this.claimGuestProgress());const a=this.container.querySelector('[data-action="skip-claim"]');a&&a.addEventListener("click",()=>{this.clearGuestData(),this.claimModal&&(this.claimModal.style.display="none")}),this.container.querySelectorAll("[data-allocate-stat]").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.allocateStat;this.allocateStat(e)})});const i=this.container.querySelector('[data-action="close-levelup"]');i&&i.addEventListener("click",()=>this.hideLevelUpModal()),this.container.querySelectorAll('[data-action="show-reset"]').forEach(t=>{t.addEventListener("click",()=>this.showResetModal())});const r=this.container.querySelector('[data-action="confirm-reset"]');r&&r.addEventListener("click",()=>this.resetCharacter());const n=this.container.querySelector('[data-action="cancel-reset"]');n&&n.addEventListener("click",()=>this.hideResetModal())}}class g{constructor(t){this.container=t,this.storageKey="site_rpg_rolled_stats",this.expirationDays=7,this.rollBtn=t.querySelector('[data-action="roll-stats"]'),this.resetBtn=t.querySelector('[data-action="reset-stats"]'),this.statsIndicator=t.querySelector(".site-rpg-card__stats-indicator"),this.statElements=t.querySelectorAll(".site-rpg-card__stat"),this.bindEvents(),this.loadFromStorage()}roll4d6DropLowest(){const t=[];for(let e=0;e<4;e++)t.push(Math.floor(6*Math.random())+1);return t.sort((t,e)=>e-t),t[0]+t[1]+t[2]}scaleToStatRange(t){return Math.round((t-3)/15*19+1)}rollAllStats(){const t={};return["strength","wisdom","charisma","stamina","agility","intelligence"].forEach(e=>{const s=this.roll4d6DropLowest();t[e]=this.scaleToStatRange(s)}),t}saveToStorage(t){const e={stats:t,rolledAt:Date.now(),expiresAt:Date.now()+24*this.expirationDays*60*60*1e3};localStorage.setItem(this.storageKey,JSON.stringify(e))}loadFromStorage(){const t=localStorage.getItem(this.storageKey);if(!t)return this.showSiteStats(),null;try{const e=JSON.parse(t);return e.expiresAt&&Date.now()>e.expiresAt?(this.clearRolledStats(),null):(this.applyRolledStats(e.stats),e.stats)}catch(t){return this.clearRolledStats(),null}}clearRolledStats(){localStorage.removeItem(this.storageKey),this.showSiteStats()}applyRolledStats(t){this.statElements.forEach(e=>{const s=e.dataset.stat;void 0!==t[s]&&this.updateStatDisplay(e,t[s])}),this.showRolledIndicator()}showSiteStats(){this.statElements.forEach(t=>{const e=parseInt(t.dataset.siteValue,10);this.updateStatDisplay(t,e)}),this.hideRolledIndicator()}updateStatDisplay(t,e){t.dataset.value=e;const s=t.querySelector(".site-rpg-card__stat-value");s&&(s.innerHTML=`${e}<span class="site-rpg-card__stat-max">/20</span>`);const a=t.querySelector(".site-rpg-card__stat-fill");a&&(a.style.width=`${Math.min(5*e,100)}%`)}showRolledIndicator(){this.resetBtn&&(this.resetBtn.style.display="inline-flex"),this.statsIndicator&&(this.statsIndicator.style.display="block")}hideRolledIndicator(){this.resetBtn&&(this.resetBtn.style.display="none"),this.statsIndicator&&(this.statsIndicator.style.display="none")}async animateRoll(){this.container.classList.add("site-rpg-block--rolling");for(let t=0;t<20;t++)this.statElements.forEach(t=>{const e=Math.floor(20*Math.random())+1;this.updateStatDisplay(t,e)}),await new Promise(t=>setTimeout(t,60));this.container.classList.remove("site-rpg-block--rolling")}getPlayerStats(){const t={};return this.statElements.forEach(e=>{t[e.dataset.stat]=parseInt(e.dataset.value,10)||10}),t}static getStatBonus(t){return Math.floor((t-10)/2)}getStatBonuses(){const t=this.getPlayerStats();return{str:g.getStatBonus(t.strength),wis:g.getStatBonus(t.wisdom),cha:g.getStatBonus(t.charisma),sta:g.getStatBonus(t.stamina),agi:g.getStatBonus(t.agility),int:g.getStatBonus(t.intelligence)}}bindEvents(){this.rollBtn&&this.rollBtn.addEventListener("click",async()=>{await this.animateRoll();const t=this.rollAllStats();this.saveToStorage(t),this.applyRolledStats(t)}),this.resetBtn&&this.resetBtn.addEventListener("click",()=>{this.clearRolledStats()})}}class m{constructor(t){this.manager=t,this.canvas=t.canvas,this.ctx=t.ctx,this.container=t.container,this.isRunning=!1,this.isPaused=!1,this.score=0,this.difficulty=t.difficulty,this.keys=new Set,this.keyDownHandler=t=>this.handleKeyDown(t),this.keyUpHandler=t=>this.handleKeyUp(t),document.addEventListener("keydown",this.keyDownHandler),document.addEventListener("keyup",this.keyUpHandler)}start(){this.isRunning=!0,this.isPaused=!1,this.score=0,this.gameLoop()}stop(){this.isRunning=!1,document.removeEventListener("keydown",this.keyDownHandler),document.removeEventListener("keyup",this.keyUpHandler)}togglePause(){this.isPaused=!this.isPaused,this.isPaused||this.gameLoop()}handleKeyDown(t){}handleKeyUp(t){}gameLoop(){this.isRunning&&!this.isPaused&&(this.update(),this.render(),requestAnimationFrame(()=>this.gameLoop()))}update(){}render(){}}class y extends m{constructor(t,e={},s={}){super(t),this.bonuses={str:e.str||0,wis:e.wis||0,sta:e.sta||0,agi:e.agi||0,int:e.int||0},this.effects=s;let a=c[this.difficulty].playerHealth;const i=Math.floor(.5*this.bonuses.sta);this.effects.firewall&&(a+=1),this.effects.shieldWall&&(a+=1);const r=Math.max(1,a+i);let n=4;const o=.2*this.bonuses.agi;this.effects.swiftMovement&&(n+=1);const l=Math.max(2,n+o);this.player={x:60,y:this.canvas.height/2,width:24,height:32,speed:l,facing:1,isAttacking:!1,attackFrame:0,attackCooldown:0,health:r,maxHealth:r,invincible:0};let h=20-this.bonuses.int;this.effects.scriptMastery&&(h=Math.floor(.85*h)),this.attackCooldownMax=Math.max(10,h),this.enemies=[],this.particles=[],this.wave=1,this.totalWaves=5,this.enemiesToSpawn=[],this.spawnTimer=0,this.waveComplete=!1,this.waveTransitionTimer=0,this.screenShake=0,this.touchControls={up:!1,down:!1,left:!1,right:!1,attack:!1},this.setupMobileControls()}setupMobileControls(){const t=this.container.querySelector(".site-rpg-dpad"),e=this.container.querySelector(".site-rpg-attack-btn");t&&["up","down","left","right"].forEach(e=>{const s=t.querySelector(`[data-dir="${e}"]`);s&&(s.addEventListener("touchstart",t=>{t.preventDefault(),this.touchControls[e]=!0}),s.addEventListener("touchend",t=>{t.preventDefault(),this.touchControls[e]=!1}))}),e&&e.addEventListener("touchstart",t=>{t.preventDefault(),this.player.attackCooldown<=0&&this.attack()})}start(){super.start(),this.setupWave(),this.manager.updateHUD(this.wave,this.totalWaves,this.score,this.player.health,this.player.maxHealth)}setupWave(){const t=["spamBot","spamBot","spamBot","phantom404","goblin"],e=3+2*this.wave;this.enemiesToSpawn=[];for(let s=0;s<e;s++)this.enemiesToSpawn.push(t[Math.floor(Math.random()*Math.min(this.wave+1,t.length))]);this.wave===this.totalWaves&&this.enemiesToSpawn.push("dragon"),this.waveComplete=!1}handleKeyDown(t){if(this.isRunning)if(!this.isPaused||"Escape"!==t.code&&"KeyP"!==t.code){if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","KeyW","KeyA","KeyS","KeyD","Escape","KeyP"].includes(t.code)){if(t.preventDefault(),"Escape"===t.code||"KeyP"===t.code)return void this.togglePause();this.keys.add(t.code),"Space"===t.code&&this.player.attackCooldown<=0&&this.attack()}}else this.togglePause()}handleKeyUp(t){this.keys.delete(t.code)}gameLoop(){if(this.isRunning&&!this.isPaused){if(this.waveTransitionTimer>0)return this.waveTransitionTimer--,this.render(),void requestAnimationFrame(()=>this.gameLoop());this.spawnEnemies(),this.update(),0!==this.enemies.length||0!==this.enemiesToSpawn.length||this.waveComplete||this.completeWave(),this.render(),requestAnimationFrame(()=>this.gameLoop())}}spawnEnemies(){if(0!==this.enemiesToSpawn.length&&(this.spawnTimer++,this.spawnTimer>=50)){this.spawnTimer=0;const t=this.enemiesToSpawn.shift();this.spawnEnemy(t)}}spawnEnemy(t){const e={spamBot:{hp:1,xp:5,speed:1.5,size:24,emoji:"ü§ñ"},phantom404:{hp:2,xp:10,speed:2,size:28,emoji:"üëª"},goblin:{hp:1,xp:8,speed:3,size:22,emoji:"üë∫"},dragon:{hp:10,xp:100,speed:.8,size:48,emoji:"üêâ",boss:!0}},s=e[t]||e.spamBot;this.enemies.push({...s,x:this.canvas.width+s.size,y:Math.random()*(this.canvas.height-2*s.size)+s.size,knockback:0})}update(){let t=0,e=0;const s=this.player.speed;(this.keys.has("ArrowUp")||this.keys.has("KeyW")||this.touchControls.up)&&(e=-s),(this.keys.has("ArrowDown")||this.keys.has("KeyS")||this.touchControls.down)&&(e=s),(this.keys.has("ArrowLeft")||this.keys.has("KeyA")||this.touchControls.left)&&(t=-s,this.player.facing=-1),(this.keys.has("ArrowRight")||this.keys.has("KeyD")||this.touchControls.right)&&(t=s,this.player.facing=1),this.player.x=Math.max(20,Math.min(.6*this.canvas.width,this.player.x+t)),this.player.y=Math.max(20,Math.min(this.canvas.height-20,this.player.y+e)),this.player.attackCooldown>0&&this.player.attackCooldown--,this.player.invincible>0&&this.player.invincible--,this.screenShake>0&&this.screenShake--,this.player.isAttacking&&(this.player.attackFrame++,this.player.attackFrame>=15&&(this.player.isAttacking=!1,this.player.attackFrame=0));for(let t=this.enemies.length-1;t>=0;t--){const e=this.enemies[t];if(e.knockback>0){e.x+=5,e.knockback--;continue}e.x-=e.speed;const s=this.player.y;e.y+=.5*Math.sign(s-e.y),this.player.invincible<=0&&Math.hypot(e.x-this.player.x,e.y-this.player.y)<(e.size+this.player.width)/2&&this.playerHit(),e.x<-e.size&&this.enemies.splice(t,1)}for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.x+=e.dx,e.y+=e.dy,e.life--,e.life<=0&&this.particles.splice(t,1)}}attack(){this.player.isAttacking=!0,this.player.attackFrame=0,this.player.attackCooldown=this.attackCooldownMax;let t=Math.max(1,1+Math.floor(.5*this.bonuses.str));this.effects.powerStrike&&(t=Math.ceil(1.15*t));for(let e=this.enemies.length-1;e>=0;e--){const s=this.enemies[e],a=this.player.x+(1===this.player.facing?0:-45);if(s.x>a&&s.x<a+45+this.player.width&&Math.abs(s.y-this.player.y)<35){let a=t;if(this.effects.giantSlayer&&s.boss&&(a=Math.ceil(1.1*a)),s.hp-=a,s.knockback=5,this.spawnParticles(s.x,s.y,"#e74c3c"),s.hp<=0){let t=1+.05*this.bonuses.wis;this.effects.adaptable&&(t+=.05),this.effects.arcaneKnowledge&&(t+=.1);const a=Math.round(s.xp*Math.max(.5,t));this.score+=a,this.spawnParticles(s.x,s.y,"#f39c12",10),s.boss&&(this.screenShake=15),this.enemies.splice(e,1),this.manager.updateHUD(this.wave,this.totalWaves,this.score,this.player.health,this.player.maxHealth)}}}}playerHit(){this.player.health--,this.player.invincible=60,this.screenShake=10,this.spawnParticles(this.player.x,this.player.y,"#e74c3c"),this.manager.updateHUD(this.wave,this.totalWaves,this.score,this.player.health,this.player.maxHealth),this.player.health<=0&&this.manager.endCurrentGame()}spawnParticles(t,e,s,a=5){for(let i=0;i<a;i++){const a=Math.random()*Math.PI*2;this.particles.push({x:t,y:e,dx:2*Math.cos(a),dy:2*Math.sin(a),color:s,life:30})}}completeWave(){this.waveComplete=!0,this.score+=10*this.wave,this.manager.updateHUD(this.wave,this.totalWaves,this.score,this.player.health,this.player.maxHealth),this.wave>=this.totalWaves?setTimeout(()=>this.manager.endCurrentGame(),1500):(this.wave++,this.waveTransitionTimer=90,setTimeout(()=>this.setupWave(),1500))}render(){const t=this.ctx;if(t.save(),this.screenShake>0&&t.translate((Math.random()-.5)*this.screenShake,(Math.random()-.5)*this.screenShake),t.fillStyle="#1a1a2e",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.strokeStyle="#333",t.beginPath(),t.moveTo(0,this.canvas.height-20),t.lineTo(this.canvas.width,this.canvas.height-20),t.stroke(),this.player.invincible<=0||Math.floor(this.player.invincible/4)%2==0){if(t.save(),t.translate(this.player.x,this.player.y),-1===this.player.facing&&t.scale(-1,1),t.fillStyle="#c0c0c0",t.fillRect(-6,-16,12,6),t.fillStyle="#a0a0a0",t.fillRect(-6,-10,12,12),t.fillStyle="#654321",t.fillRect(-6,2,5,12),t.fillRect(1,2,5,12),this.player.isAttacking){const e=Math.min(3*this.player.attackFrame,20);t.fillStyle="#e0e0e0",t.fillRect(6,-4,10+e,4)}t.restore()}for(const e of this.enemies)if(t.font=`${e.size}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(e.emoji,e.x,e.y),e.boss){const s=e.size;t.fillStyle="#333",t.fillRect(e.x-s/2,e.y-e.size/2-8,s,4),t.fillStyle="#e74c3c",t.fillRect(e.x-s/2,e.y-e.size/2-8,s*(e.hp/10),4)}for(const e of this.particles)t.fillStyle=e.color,t.globalAlpha=e.life/30,t.beginPath(),t.arc(e.x,e.y,3,0,2*Math.PI),t.fill(),t.globalAlpha=1;this.waveTransitionTimer>0&&(t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.font="bold 24px sans-serif",t.textAlign="center",t.fillStyle="#f39c12",t.fillText(this.wave>this.totalWaves?"VICTORY!":`Wave ${this.wave} incoming...`,this.canvas.width/2,this.canvas.height/2)),this.isPaused&&(t.fillStyle="rgba(0,0,0,0.7)",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.font="bold 28px sans-serif",t.textAlign="center",t.fillStyle="#f39c12",t.fillText("PAUSED",this.canvas.width/2,this.canvas.height/2)),t.restore()}}class f extends m{constructor(t,e={},s={}){super(t),this.bonuses={agi:e.agi||0,sta:e.sta||0,wis:e.wis||0,int:e.int||0},this.effects=s,this.groundY=this.canvas.height-80,this.jumpVelocity=-15-.25*this.bonuses.agi,this.doubleJumpVelocity=-12-.2*this.bonuses.agi,this.doubleJumpWindow=this.effects.quickReflexes?1.2:1,this.player={x:80,y:this.groundY,width:30,height:40,velocityY:0,isJumping:!1,canDoubleJump:!0,jumpTime:0},this.hasShield=this.bonuses.sta>=0,this.effects.firewall?this.shieldCharges=this.hasShield?2:1:this.shieldCharges=this.hasShield?1:0,this.effects.shieldWall&&(this.shieldCharges+=1),this.obstacles=[],this.collectibles=[],this.distance=0,this.speed=3,this.maxSpeed=6,this.obstacleTimer=0,this.collectibleTimer=0,this.gameOver=!1,this.collectibleSpawnRate=Math.max(60,100-4*this.bonuses.int),this.setupControls()}setupControls(){const t=this.container.querySelector(".site-rpg-jump-btn");t&&t.addEventListener("touchstart",t=>{t.preventDefault(),this.jump()}),this.canvas.addEventListener("click",()=>this.jump())}handleKeyDown(t){"Space"!==t.code&&"ArrowUp"!==t.code||(t.preventDefault(),this.jump())}jump(){this.player.isJumping?this.player.canDoubleJump&&(this.player.velocityY=this.doubleJumpVelocity,this.player.canDoubleJump=!1):(this.player.velocityY=this.jumpVelocity,this.player.isJumping=!0,this.player.canDoubleJump=!0)}start(){super.start(),this.manager.updateHUD(1,1,0,1,1),this.manager.waveDisplay.textContent="Distance: 0m"}update(){if(!this.gameOver){if(this.player.velocityY+=.8,this.player.y+=this.player.velocityY,this.player.y>=this.groundY&&(this.player.y=this.groundY,this.player.velocityY=0,this.player.isJumping=!1),this.distance+=.1*this.speed,this.speed=Math.min(3+.005*this.distance,this.maxSpeed),this.score=Math.floor(this.distance),this.obstacleTimer++,this.obstacleTimer>120-Math.min(.05*this.distance,50)){this.obstacleTimer=0;const t=25+25*Math.random();this.obstacles.push({x:this.canvas.width,y:this.groundY-t+40,width:30,height:t,emoji:["üêõ","ü™≤","‚ö†Ô∏è","üî¥"][Math.floor(4*Math.random())]})}if(this.collectibleTimer++,this.collectibleTimer>this.collectibleSpawnRate){this.collectibleTimer=0;const t=10+Math.floor(20*Math.random());let e=1+.05*this.bonuses.wis;this.effects.adaptable&&(e+=.05),this.effects.arcaneKnowledge&&(e+=.1),this.collectibles.push({x:this.canvas.width,y:this.groundY-60-80*Math.random(),emoji:["üîå","üì¶","‚≠ê","üíé"][Math.floor(4*Math.random())],points:Math.round(t*Math.max(.5,e))})}for(let t=this.obstacles.length-1;t>=0;t--)this.obstacles[t].x-=this.speed,this.obstacles[t].x<-50&&this.obstacles.splice(t,1);for(let t=this.collectibles.length-1;t>=0;t--){this.collectibles[t].x-=this.speed;const e=this.collectibles[t];Math.abs(e.x-this.player.x)<30&&Math.abs(e.y-(this.player.y-20))<40?(this.score+=e.points,this.collectibles.splice(t,1)):e.x<-30&&this.collectibles.splice(t,1)}this.manager.waveDisplay.textContent=`Distance: ${Math.floor(this.distance)}m`,this.manager.scoreDisplay.textContent=`XP: ${this.score}`,this.manager.score=this.score;for(const t of this.obstacles)if(this.player.x+15>t.x&&this.player.x-15<t.x+t.width&&this.player.y>t.y-20){if(this.effects.cacheSpirit&&Math.random()<.1){const e=this.obstacles.indexOf(t);e>-1&&this.obstacles.splice(e,1);continue}if(this.shieldCharges>0){this.shieldCharges--;const e=this.obstacles.indexOf(t);return void(e>-1&&this.obstacles.splice(e,1))}return this.gameOver=!0,void this.manager.endCurrentGame()}}}render(){const t=this.ctx,e=t.createLinearGradient(0,0,0,this.canvas.height);e.addColorStop(0,"#1e3c72"),e.addColorStop(1,"#2a5298"),t.fillStyle=e,t.fillRect(0,0,this.canvas.width,this.canvas.height),t.fillStyle="#2d2d2d",t.fillRect(0,this.groundY+40,this.canvas.width,this.canvas.height-this.groundY),t.fillStyle="#3d3d3d",t.fillRect(0,this.groundY+35,this.canvas.width,10),t.font="40px sans-serif",t.textAlign="center",t.fillText("üèÉ",this.player.x,this.player.y);for(const e of this.obstacles)t.font=`${e.height}px sans-serif`,t.fillText(e.emoji,e.x+e.width/2,e.y+e.height/2);for(const e of this.collectibles)t.font="28px sans-serif",t.fillText(e.emoji,e.x,e.y);this.isPaused&&(t.fillStyle="rgba(0,0,0,0.7)",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.font="bold 28px sans-serif",t.textAlign="center",t.fillStyle="#f39c12",t.fillText("PAUSED",this.canvas.width/2,this.canvas.height/2))}}class v extends m{constructor(t,e={},s={}){super(t),this.bonuses={str:e.str||0,wis:e.wis||0,sta:e.sta||0,agi:e.agi||0,int:e.int||0,cha:e.cha||0},this.effects=s,this.difficultySettings=h[this.difficulty]||h.normal,this.classes={warrior:{name:"Warrior",attackBonus:2,damage:10,hp:22,ac:15,emoji:"‚öîÔ∏è",special:"cleave",critBonus:1.5,specialName:"Shield Bash",specialDesc:"Stun boss for 1 turn"},mage:{name:"Mage",attackBonus:0,damageRolls:2,damage:6,hp:14,ac:11,emoji:"üîÆ",special:"spellpower",acIgnore:2,specialName:"Arcane Blast",specialDesc:"Auto-hit for 3d6 damage"},rogue:{name:"Rogue",attackBonus:3,damage:6,hp:16,ac:13,emoji:"üó°Ô∏è",special:"sneak",critRange:[19,20],specialName:"Backstab",specialDesc:"Double damage if boss missed"}};let a=Math.floor(.5*this.bonuses.int);this.effects.penetratingSpell&&(a+=1);const i=this.difficultySettings;this.bosses=[{name:"Spam Golem",ac:Math.max(5,10-a+i.acMod),hp:Math.round(25*i.hpMult),damage:Math.round(4*i.damageMult),attackBonus:2,emoji:"üóø",abilities:[{name:"Spam Barrage",type:"multiAttack",attacks:2,damageMod:.5},{name:"Email Flood",type:"debuff",stat:"accuracy",value:-2,duration:2}]},{name:"404 Wraith",ac:Math.max(5,12-a+i.acMod),hp:Math.round(30*i.hpMult),damage:Math.round(5*i.damageMult),attackBonus:3,emoji:"üëª",abilities:[{name:"Phase Shift",type:"phase",missChance:50},{name:"Ghost Touch",type:"ignoreAC"}]},{name:"Slow Load Snail",ac:Math.max(5,8-a+i.acMod),hp:Math.round(40*i.hpMult),damage:Math.round(3*i.damageMult),attackBonus:1,emoji:"üêå",abilities:[{name:"Buffer Overflow",type:"heal",amount:10},{name:"Lag Spike",type:"stun",duration:1}]},{name:"Malware Dragon",ac:Math.max(5,14-a+i.acMod),hp:Math.round(45*i.hpMult),damage:Math.round(7*i.damageMult),attackBonus:4,emoji:"üêâ",abilities:[{name:"Virus Injection",type:"dot",damage:3,duration:3},{name:"Ransomware",type:"lockAction",action:"defend",duration:2}]},{name:"DDoS Titan",ac:Math.max(5,16-a+i.acMod),hp:Math.round(60*i.hpMult),damage:Math.round(10*i.damageMult),attackBonus:5,emoji:"üëπ",abilities:[{name:"Server Overload",type:"heavyAttack",damageMult:1.5},{name:"Bandwidth Drain",type:"debuff",stat:"damage",value:-2,duration:2}]}];const r=this.classes[t.selectedClass]||this.classes.warrior;this.playerClass={...r},this.playerClass.attackBonus+=Math.floor(.5*this.bonuses.wis);let n=this.bonuses.sta;this.effects.firewall&&(n+=2),this.effects.shieldWall&&(n+=2),this.playerClass.hp=Math.max(5,this.playerClass.hp+n),this.playerClass.ac+=Math.floor(.5*this.bonuses.agi),this.defendBonus=4+Math.max(0,Math.floor(.5*this.bonuses.agi)),this.player={hp:this.playerClass.hp,maxHp:this.playerClass.hp,ac:this.playerClass.ac,tempAC:0,isDefending:!1,isStunned:!1,defendLocked:!1,specialUsed:!1},this.statusEffects={player:[],boss:[]},this.currentBossIndex=0,this.boss=null,this.turn="player",this.isRolling=!1,this.canAct=!0,this.combatLog=[],this.particles=[],this.floatingText=[],this.screenShake=0,this.bossLastMissed=!1,this.playerAnim={flash:0,shake:0},this.bossAnim={flash:0,shake:0},this.diceEl=this.container.querySelector(".site-rpg-d20-dice__value"),this.turnIndicator=this.container.querySelector(".site-rpg-d20-turn__text"),this.attackBtn=this.container.querySelector(".site-rpg-d20-attack-btn"),this.defendBtn=this.container.querySelector(".site-rpg-d20-defend-btn"),this.rollResult=this.container.querySelector(".site-rpg-d20-roll-result"),this.rollFormula=this.container.querySelector(".site-rpg-d20-roll__formula"),this.rollOutcome=this.container.querySelector(".site-rpg-d20-roll__outcome"),this.combatLogEl=this.container.querySelector(".site-rpg-d20-combat-log__entries"),this.statusEffectsEl=this.container.querySelector(".site-rpg-d20-status-effects"),this.setupControls()}setupControls(){this.attackBtn&&this.attackBtn.addEventListener("click",()=>{this.isPaused||!this.canAct||"player"!==this.turn||this.isRolling||this.player.isStunned||this.playerAttack()}),this.defendBtn&&this.defendBtn.addEventListener("click",()=>{this.isPaused||!this.canAct||"player"!==this.turn||this.isRolling||this.player.isStunned||this.player.defendLocked||this.playerDefend()})}start(){super.start(),this.spawnBoss(),this.addCombatLog(`A wild ${this.boss.name} appears!`),this.addCombatLog(`You are a ${this.playerClass.name}. Roll to attack!`),this.updateUI()}spawnBoss(){const t=this.bosses[this.currentBossIndex];this.boss={...t,currentHp:t.hp,maxHp:t.hp},this.turn="player",this.canAct=!0,this.updateUI()}rollD20(){return Math.floor(20*Math.random())+1}rollDamage(){const t=this.playerClass.damageRolls||1;let e=0;for(let s=0;s<t;s++)e+=Math.floor(Math.random()*this.playerClass.damage)+1;return Math.max(1,e+Math.floor(.5*this.bonuses.str))}async animateDiceRoll(t){this.isRolling=!0;const e=this.diceEl,s=Date.now();return new Promise(a=>{const i=()=>{Date.now()-s<500?(e.textContent=Math.floor(20*Math.random())+1,e.parentElement.classList.add("site-rpg-d20-dice--rolling"),requestAnimationFrame(i)):(e.textContent=t,e.parentElement.classList.remove("site-rpg-d20-dice--rolling"),this.isRolling=!1,a())};i()})}async playerAttack(){this.canAct=!1,this.attackBtn.disabled=!0,this.defendBtn&&(this.defendBtn.disabled=!0);const t=this.rollD20();await this.animateDiceRoll(t);const e=t+this.playerClass.attackBonus,s=(this.effects.precisionStrike?[18,19,20]:[20]).includes(t),a=1===t;let i=!a&&(s||e>=this.boss.ac);const r=this.statusEffects.boss.find(t=>"phase"===t.type);if(i&&r&&100*Math.random()<r.missChance&&(i=!1,this.addCombatLog(`Your attack passes through ${this.boss.name}!`)),this.rollFormula.textContent=`Rolled ${t} + ${this.playerClass.attackBonus} = ${e} vs AC ${this.boss.ac}`,i){let t=this.rollDamage();if(this.effects.giantSlayer&&(t=Math.ceil(1.1*t)),s?(t*=2,this.rollOutcome.textContent="CRITICAL HIT!",this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--crit",this.addCombatLog(`CRITICAL HIT! You deal ${t} damage!`)):(this.rollOutcome.textContent=`HIT! ${t} damage`,this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--hit",this.addCombatLog(`Hit! You deal ${t} damage to ${this.boss.name}.`)),this.boss.currentHp-=t,this.screenShake=s?15:8,this.spawnParticles(this.canvas.width-120,this.canvas.height/2,"#e74c3c",s?15:8),this.spawnFloatingText(`-${t}`,this.canvas.width-120,this.canvas.height/2-30,s?"#f39c12":"#e74c3c",s),this.score+=2*t,this.boss.currentHp<=0){this.boss.currentHp=0,this.addCombatLog(`${this.boss.name} has been defeated!`);const t=50+25*this.currentBossIndex;let e=1+.05*this.bonuses.cha;return this.effects.adaptable&&(e+=.05),this.effects.arcaneKnowledge&&(e+=.1),this.score+=Math.round(t*Math.max(.5,e)),this.spawnParticles(this.canvas.width-120,this.canvas.height/2,"#f39c12",20),this.currentBossIndex++,this.currentBossIndex>=this.bosses.length?(this.addCombatLog("Victory! You defeated all the bosses!"),void setTimeout(()=>this.manager.endCurrentGame(),2e3)):(this.addCombatLog("Prepare for the next boss..."),void setTimeout(()=>{this.spawnBoss(),this.addCombatLog(`${this.boss.name} appears!`),this.canAct=!0,this.attackBtn.disabled=!1,this.updateUI()},1500))}}else a?(this.rollOutcome.textContent="CRITICAL MISS!",this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--miss",this.addCombatLog("Critical miss! You stumble!")):(this.rollOutcome.textContent="MISS!",this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--miss",this.addCombatLog("Miss! Your attack fails to connect."));this.rollResult.style.display="block",this.updateUI(),setTimeout(()=>this.bossAttack(),1500)}playerDefend(){this.canAct=!1,this.attackBtn.disabled=!0,this.defendBtn&&(this.defendBtn.disabled=!0),this.player.isDefending=!0,this.player.tempAC=this.defendBonus;const t=this.player.ac+this.player.tempAC;this.rollFormula.textContent=`Defending: AC ${this.player.ac} + ${this.player.tempAC} = ${t}`,this.rollOutcome.textContent="üõ°Ô∏è DEFENDING",this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--defend",this.rollResult.style.display="block",this.addCombatLog(`You raise your guard! (AC +${this.player.tempAC}, damage halved)`),this.updateUI(),setTimeout(()=>this.bossAttack(),1e3)}async bossAttack(){if(this.turn="boss",this.updateUI(),Math.random()<.4&&this.boss.abilities&&this.boss.abilities.length>0?await this.executeBossAbility():await this.bossNormalAttack(),this.processStatusEffects(),this.player.hp<=0)return this.player.hp=0,this.addCombatLog("You have been defeated!"),void setTimeout(()=>this.manager.endCurrentGame(),1500);this.updateUI(),setTimeout(()=>{this.player.isDefending=!1,this.player.tempAC=0,this.tickStatusEffects(),this.turn="player",this.canAct=!0,this.attackBtn.disabled=!1,this.defendBtn&&!this.player.defendLocked&&(this.defendBtn.disabled=!1),this.updateUI()},1500)}async bossNormalAttack(){const t=this.player.ac+this.player.tempAC,e=this.rollD20();await this.animateDiceRoll(e);const s=e+this.boss.attackBonus,a=20===e,i=1===e,r=!i&&(a||s>=t);if(this.bossLastMissed=!r,this.rollFormula.textContent=`${this.boss.name} rolls ${e} + ${this.boss.attackBonus} = ${s} vs AC ${t}`,r){let t=Math.floor(Math.random()*this.boss.damage)+1;if(a&&(t*=2),this.player.isDefending){const e=t;t=Math.max(1,Math.floor(t/2)),this.addCombatLog(`Your defense reduces damage from ${e} to ${t}!`)}a?(this.rollOutcome.textContent=`CRITICAL! ${t} damage to you!`,this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--crit",this.addCombatLog(`CRITICAL! ${this.boss.name} deals ${t} damage!`)):(this.rollOutcome.textContent=`HIT! ${t} damage to you`,this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--hit",this.addCombatLog(`${this.boss.name} hits you for ${t} damage.`)),this.player.hp-=t,this.screenShake=a?15:8,this.spawnParticles(120,this.canvas.height/2,"#9b59b6",a?15:8),this.spawnFloatingText(`-${t}`,120,this.canvas.height/2-30,a?"#f39c12":"#9b59b6",a)}else i?(this.rollOutcome.textContent=`${this.boss.name} fumbles!`,this.addCombatLog(`${this.boss.name} critically misses!`)):(this.rollOutcome.textContent=`${this.boss.name} misses!`,this.addCombatLog(`${this.boss.name} misses you.`)),this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--miss"}async executeBossAbility(){const t=this.boss.abilities[Math.floor(Math.random()*this.boss.abilities.length)];switch(this.rollFormula.textContent=`${this.boss.name} uses ${t.name}!`,this.rollOutcome.textContent=`‚ö° ${t.name.toUpperCase()}`,this.rollOutcome.className="site-rpg-d20-roll__outcome site-rpg-d20-roll__outcome--ability",this.rollResult.style.display="block",this.addCombatLog(`${this.boss.name} uses ${t.name}!`),t.type){case"multiAttack":{const e=t.attacks||2,s=t.damageMod||.5;let a=0;for(let t=0;t<e;t++){const t=this.rollD20(),e=this.player.ac+this.player.tempAC;if(1!==t&&(20===t||t+this.boss.attackBonus>=e)){let t=Math.max(1,Math.floor((Math.random()*this.boss.damage+1)*s));this.player.isDefending&&(t=Math.max(1,Math.floor(t/2))),a+=t}}a>0?(this.player.hp-=a,this.addCombatLog(`${e} hits deal ${a} total damage!`),this.screenShake=10,this.spawnParticles(120,this.canvas.height/2,"#9b59b6",10),this.spawnFloatingText(`-${a}`,120,this.canvas.height/2-30,"#9b59b6",!1)):this.addCombatLog("All attacks missed!"),this.bossLastMissed=0===a;break}case"debuff":this.statusEffects.player.push({type:"debuff",stat:t.stat,value:t.value,duration:t.duration,name:t.name}),this.addCombatLog(`${t.stat} reduced by ${Math.abs(t.value)} for ${t.duration} turns!`),this.bossLastMissed=!1;break;case"phase":this.statusEffects.boss.push({type:"phase",missChance:t.missChance,duration:1,name:t.name}),this.addCombatLog(`${this.boss.name} phases out of existence!`),this.bossLastMissed=!1;break;case"ignoreAC":{let t=Math.floor(Math.random()*this.boss.damage)+1;this.player.isDefending&&(t=Math.max(1,Math.floor(t/2))),this.player.hp-=t,this.addCombatLog(`Ghost Touch ignores armor! ${t} damage!`),this.screenShake=8,this.spawnParticles(120,this.canvas.height/2,"#9b59b6",8),this.spawnFloatingText(`-${t}`,120,this.canvas.height/2-30,"#9b59b6",!1),this.bossLastMissed=!1;break}case"heal":{const e=Math.min(t.amount,this.boss.maxHp-this.boss.currentHp);this.boss.currentHp+=e,this.addCombatLog(`${this.boss.name} heals for ${e} HP!`),this.spawnParticles(this.canvas.width-120,this.canvas.height/2,"#27ae60",10),this.spawnFloatingText(`+${e}`,this.canvas.width-120,this.canvas.height/2-30,"#27ae60",!1),this.bossLastMissed=!1;break}case"stun":this.player.isStunned=!0,this.statusEffects.player.push({type:"stun",duration:t.duration,name:t.name}),this.addCombatLog(`You are stunned for ${t.duration} turn(s)!`),this.bossLastMissed=!1;break;case"dot":this.statusEffects.player.push({type:"dot",damage:t.damage,duration:t.duration,name:t.name}),this.addCombatLog(`${t.name} will deal ${t.damage} damage per turn for ${t.duration} turns!`),this.bossLastMissed=!1;break;case"lockAction":"defend"===t.action&&(this.player.defendLocked=!0,this.defendBtn&&(this.defendBtn.disabled=!0),this.statusEffects.player.push({type:"lockAction",action:t.action,duration:t.duration,name:t.name}),this.addCombatLog(`Defend is locked for ${t.duration} turns!`)),this.bossLastMissed=!1;break;case"heavyAttack":{const e=this.rollD20(),s=this.player.ac+this.player.tempAC;if(1!==e&&(20===e||e+this.boss.attackBonus>=s)){let e=Math.floor((Math.random()*this.boss.damage+1)*(t.damageMult||1.5));this.player.isDefending&&(e=Math.max(1,Math.floor(e/2))),this.player.hp-=e,this.addCombatLog(`Heavy attack deals ${e} damage!`),this.screenShake=15,this.spawnParticles(120,this.canvas.height/2,"#e74c3c",15),this.spawnFloatingText(`-${e}`,120,this.canvas.height/2-30,"#e74c3c",!0),this.bossLastMissed=!1}else this.addCombatLog("Heavy attack misses!"),this.bossLastMissed=!0;break}default:await this.bossNormalAttack()}}processStatusEffects(){for(const t of this.statusEffects.player)"dot"===t.type&&t.duration>0&&(this.player.hp-=t.damage,this.addCombatLog(`${t.name} deals ${t.damage} damage!`),this.spawnParticles(120,this.canvas.height/2,"#8e44ad",5),this.spawnFloatingText(`-${t.damage}`,120,this.canvas.height/2-30,"#8e44ad",!1))}tickStatusEffects(){for(let t=this.statusEffects.player.length-1;t>=0;t--){const e=this.statusEffects.player[t];e.duration--,e.duration<=0&&("stun"===e.type?(this.player.isStunned=!1,this.addCombatLog("You are no longer stunned!")):"lockAction"===e.type&&"defend"===e.action?(this.player.defendLocked=!1,this.defendBtn&&(this.defendBtn.disabled=!1),this.addCombatLog("Defend is no longer locked!")):"debuff"===e.type?this.addCombatLog(`${e.name} wears off.`):"dot"===e.type&&this.addCombatLog(`${e.name} fades.`),this.statusEffects.player.splice(t,1))}for(let t=this.statusEffects.boss.length-1;t>=0;t--){const e=this.statusEffects.boss[t];e.duration--,e.duration<=0&&("phase"===e.type&&this.addCombatLog(`${this.boss.name} becomes solid again.`),this.statusEffects.boss.splice(t,1))}}addCombatLog(t,e=null){if(this.combatLog.push(t),this.combatLog.length>50&&this.combatLog.shift(),this.combatLogEl){const s=document.createElement("div");let a=e;if(!a){const e=t.toLowerCase();e.includes("critical hit")||e.includes("critical!")?a="crit":e.includes("hit!")||e.includes("deal")&&e.includes("damage")?a="hit":e.includes("miss")||e.includes("passes through")?a="miss":e.includes("uses")||e.includes("stunned")||e.includes("locked")||e.includes("virus")||e.includes("phases")?a="ability":e.includes("heals")||e.includes("defense reduces")?a="heal":(e.includes("defeated")||e.includes("victory"))&&(a="victory")}s.className="site-rpg-d20-combat-log__entry"+(a?` site-rpg-d20-combat-log__entry--${a}`:""),s.textContent=t,this.combatLogEl.appendChild(s),this.combatLogEl.scrollTop=this.combatLogEl.scrollHeight}}updateUI(){this.turnIndicator&&(this.turnIndicator.textContent="player"===this.turn?"Your Turn":`${this.boss?.name||"Boss"}'s Turn`,this.turnIndicator.parentElement.className=`site-rpg-d20-turn-indicator site-rpg-d20-turn-indicator--${this.turn}`),this.manager.updateHUD(this.currentBossIndex+1,this.bosses.length,this.score,this.player.hp,this.player.maxHp),this.manager.waveDisplay&&(this.manager.waveDisplay.textContent=this.boss?this.boss.name:"Boss Rush")}spawnParticles(t,e,s,a=5){for(let i=0;i<a;i++){const a=Math.random()*Math.PI*2;this.particles.push({x:t,y:e,dx:3*Math.cos(a),dy:3*Math.sin(a),color:s,life:30})}}spawnFloatingText(t,e,s,a="#e74c3c",i=!1){this.floatingText.push({text:t,x:e+20*(Math.random()-.5),y:s,color:a,life:60,isCrit:i,scale:i?1.5:1})}update(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.x+=e.dx,e.y+=e.dy,e.life--,e.life<=0&&this.particles.splice(t,1)}for(let t=this.floatingText.length-1;t>=0;t--){const e=this.floatingText[t];e.y-=1.5,e.life--,e.life<=0&&this.floatingText.splice(t,1)}this.screenShake>0&&this.screenShake--}handleKeyDown(t){if("Escape"===t.code||"KeyP"===t.code)return t.preventDefault(),void this.togglePause();this.isPaused||this.canAct&&"player"===this.turn&&!this.isRolling&&("Space"!==t.code&&"KeyA"!==t.code||(t.preventDefault(),this.player.isStunned||this.playerAttack()),"KeyD"===t.code&&(t.preventDefault(),this.player.isStunned||this.player.defendLocked||this.playerDefend()))}handleKeyUp(){}render(){const t=this.ctx;t.save(),this.screenShake>0&&t.translate((Math.random()-.5)*this.screenShake,(Math.random()-.5)*this.screenShake),t.fillStyle="#1a1a2e",t.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.canvas.height/2;t.font="48px sans-serif",t.textAlign="center",t.fillText(this.playerClass.emoji,120,e+15),this.drawHealthBar(t,70,e+40,100,12,this.player.hp,this.player.maxHp,"#27ae60"),t.font="12px sans-serif",t.fillStyle="#ccd6f6",t.fillText(this.playerClass.name,120,e+70),t.fillText(`AC: ${this.player.ac}`,120,e+85),t.font="bold 24px sans-serif",t.fillStyle="#f39c12",t.fillText("VS",this.canvas.width/2,e+10),this.boss&&this.boss.currentHp>0&&(t.font="64px sans-serif",t.fillText(this.boss.emoji,this.canvas.width-120,e+20),this.drawHealthBar(t,this.canvas.width-170,e+50,100,12,this.boss.currentHp,this.boss.maxHp,"#e74c3c"),t.font="12px sans-serif",t.fillStyle="#ccd6f6",t.fillText(`HP: ${this.boss.currentHp}/${this.boss.maxHp}`,this.canvas.width-120,e+80),t.fillText(`AC: ${this.boss.ac}`,this.canvas.width-120,e+95));for(const e of this.particles)t.fillStyle=e.color,t.globalAlpha=e.life/30,t.beginPath(),t.arc(e.x,e.y,4,0,2*Math.PI),t.fill();t.globalAlpha=1;for(const e of this.floatingText)t.save(),t.globalAlpha=Math.min(1,e.life/30),t.font=`bold ${Math.floor(16*e.scale)}px sans-serif`,t.textAlign="center",t.fillStyle=e.color,t.strokeStyle="#000",t.lineWidth=3,t.strokeText(e.text,e.x,e.y),t.fillText(e.text,e.x,e.y),t.restore();this.isPaused&&(t.fillStyle="rgba(0,0,0,0.7)",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.font="bold 28px sans-serif",t.textAlign="center",t.fillStyle="#f39c12",t.fillText("PAUSED",this.canvas.width/2,this.canvas.height/2-10),t.font="14px sans-serif",t.fillStyle="#ccd6f6",t.fillText("Press P or ESC to resume",this.canvas.width/2,this.canvas.height/2+20)),t.restore()}drawHealthBar(t,e,s,a,i,r,n,o){t.fillStyle="#333",t.fillRect(e,s,a,i);const l=r/n*a;t.fillStyle=o,t.fillRect(e,s,l,i),t.strokeStyle="#fff",t.lineWidth=1,t.strokeRect(e,s,a,i)}}const w={easy:{healthBonus:2,dcMod:-2,xpMult:.8},normal:{healthBonus:0,dcMod:0,xpMult:1},hard:{healthBonus:-1,dcMod:2,xpMult:1.3}},_={id:"dungeon_delve",title:"The Forgotten Server Room",description:"Explore an abandoned data center and face the rogue AI within.",icon:"üñ•Ô∏è",estimatedTime:"5-10 min",startingScene:"entrance",scenes:{entrance:{id:"entrance",title:"The Entrance",icon:"üö™",text:"You stand before the rusted blast doors of an ancient server room. Strange humming sounds echo from within, and the air crackles with residual static. Faded warning signs hang crooked on the walls. This facility was abandoned decades ago, but something inside is still running...",xpReward:5,choices:[{text:"Force the doors open with brute strength",skillCheck:{stat:"strength",dc:12,success:"forced_entry",failure:"door_strain",critSuccess:"door_demolished",critFail:"door_alarm"}},{text:"Hack the access panel",skillCheck:{stat:"intelligence",dc:10,success:"panel_hacked",failure:"panel_fail"}},{text:"Search for an alternative entrance",skillCheck:{stat:"wisdom",dc:11,success:"found_vent",failure:"no_vent"}}]},forced_entry:{id:"forced_entry",title:"Brute Force",icon:"üí™",text:"With a mighty heave, you wrench the ancient doors apart. Rust flakes shower down like iron snow as the metal groans in protest. The doors screech open just enough for you to squeeze through. Ahead, a long corridor stretches into darkness, lit only by flickering emergency lights.",xpReward:10,setFlags:{entrance_forced:!0},choices:[{text:"Proceed down the corridor",nextScene:"main_corridor"}]},door_strain:{id:"door_strain",title:"Stuck!",icon:"üò§",text:"You strain against the door, muscles burning, but it barely budges. The ancient mechanism is too corroded to move by force alone. Your shoulders ache from the effort.",damage:1,damageMessage:"You strain yourself pushing!",choices:[{text:"Try the access panel instead",skillCheck:{stat:"intelligence",dc:10,success:"panel_hacked",failure:"panel_fail"}},{text:"Give it one more desperate try",skillCheck:{stat:"strength",dc:14,success:"forced_entry",failure:"door_jammed"}}]},door_demolished:{id:"door_demolished",title:"Incredible Strength!",icon:"üí•",text:"You channel all your power into a single tremendous push. The doors don't just open - they EXPLODE off their hinges, crashing into the darkness beyond! Dust and debris fill the air. When it clears, you see a clear path ahead. Your display of raw power echoes through the facility...",xpReward:20,setFlags:{entrance_demolished:!0,fearsome_entry:!0},choices:[{text:"March confidently into the facility",nextScene:"main_corridor"}]},door_alarm:{id:"door_alarm",title:"Security Alert!",icon:"üö®",text:"Your attempt to force the door triggers a hidden security system! Alarms blare and red lights flash. You hear mechanical whirring from deep within the facility - something is awakening. You manage to squeeze through the gap, but stealth is no longer an option.",damage:1,damageMessage:"A security shock zaps you!",setFlags:{alerted:!0},choices:[{text:"Rush inside before more security arrives",nextScene:"main_corridor"}]},door_jammed:{id:"door_jammed",title:"Completely Stuck",icon:"üö´",text:"The door is hopelessly jammed. Your only option now is to find another way in or try the access panel.",choices:[{text:"Examine the access panel",skillCheck:{stat:"intelligence",dc:12,success:"panel_hacked",failure:"panel_lockout"}},{text:"Search for a vent or alternate entrance",skillCheck:{stat:"wisdom",dc:13,success:"found_vent",failure:"trapped_outside"}}]},panel_hacked:{id:"panel_hacked",title:"Access Granted",icon:"üíª",text:"Your fingers dance across the ancient keypad. Despite decades of disuse, you recognize the archaic operating system. A few keystrokes later, the panel beeps approvingly and the doors slide open with a soft hiss. You also notice a security map downloaded to your device - useful!",xpReward:15,setFlags:{panel_hacked:!0,has_map:!0},giveItem:"Security Map",choices:[{text:"Enter the facility",nextScene:"main_corridor"}]},panel_fail:{id:"panel_fail",title:"Access Denied",icon:"‚ùå",text:"The ancient system rejects your commands. You get one more attempt before lockout.",choices:[{text:"Try a different approach",skillCheck:{stat:"intelligence",dc:12,success:"panel_hacked",failure:"panel_lockout"}},{text:"Force the door instead",skillCheck:{stat:"strength",dc:13,success:"forced_entry",failure:"door_strain"}}]},panel_lockout:{id:"panel_lockout",title:"System Lockout",icon:"üîí",text:'The panel flashes red: "LOCKOUT INITIATED." Your digital approach has failed completely. Time to get physical.',setFlags:{lockout:!0},choices:[{text:"Force the door open",skillCheck:{stat:"strength",dc:14,success:"forced_entry",failure:"door_strain"}}]},found_vent:{id:"found_vent",title:"Hidden Vent",icon:"üîç",text:"Your keen eyes spot a ventilation shaft hidden behind overgrown cables. It looks like a tight squeeze, but it bypasses the main entrance entirely. The stealthy approach...",xpReward:10,setFlags:{vent_entry:!0},choices:[{text:"Crawl through the vent",skillCheck:{stat:"agility",dc:10,success:"vent_success",failure:"vent_stuck"}},{text:"Go back and try the main door",nextScene:"entrance"}]},no_vent:{id:"no_vent",title:"No Luck",icon:"üòï",text:"You search around the perimeter but find nothing useful. The main entrance seems to be your only option.",choices:[{text:"Return to the main entrance",nextScene:"entrance"}]},vent_success:{id:"vent_success",title:"Stealthy Entry",icon:"ü§´",text:"You slip through the narrow vent with practiced ease. Emerging on the other side, you find yourself in a maintenance corridor. No alarms, no security - the perfect infiltration.",xpReward:15,setFlags:{stealthy:!0},choices:[{text:"Proceed carefully",nextScene:"maintenance_area"}]},vent_stuck:{id:"vent_stuck",title:"Tight Squeeze",icon:"üò∞",text:"You get wedged in the vent halfway through! After some panicked struggling, you manage to push forward, but not without some bruises.",damage:1,damageMessage:"You scrape yourself in the tight space!",choices:[{text:"Continue through to the other side",nextScene:"maintenance_area"}]},trapped_outside:{id:"trapped_outside",title:"No Way In",icon:"üíÄ",text:"You've exhausted all options. The facility remains sealed, its secrets forever beyond your reach. As you turn to leave, a security drone spots you. There is no escape...",isDeath:!0},main_corridor:{id:"main_corridor",title:"The Main Corridor",icon:"üö∂",text:'The corridor stretches ahead, lined with humming server racks that glow with ancient data. Emergency lights cast long shadows. You notice three paths: a door marked "CORE SYSTEMS" to the left, a maintenance shaft leading down, and the main hall continues ahead where you see a faint glow.',xpReward:5,choices:[{text:"Enter Core Systems",nextScene:"core_systems"},{text:"Climb down the maintenance shaft",skillCheck:{stat:"agility",dc:11,success:"maintenance_area",failure:"shaft_fall"}},{text:"Follow the glow down the main hall",nextScene:"main_hall"},{text:"Search the server racks for useful items",skillCheck:{stat:"wisdom",dc:10,success:"found_cache",failure:"nothing_useful"}}]},shaft_fall:{id:"shaft_fall",title:"Painful Descent",icon:"üí´",text:"Your foot slips on a greasy rung and you tumble down the shaft, bouncing off pipes and cables before landing hard on the maintenance floor below. Ow.",damage:2,damageMessage:"You take a nasty fall!",choices:[{text:"Dust yourself off and look around",nextScene:"maintenance_area"}]},found_cache:{id:"found_cache",title:"Hidden Cache",icon:"üì¶",text:"Behind a loose panel, you discover a maintenance kit left by some long-gone technician. Inside is a repair drone chip - could be useful!",xpReward:10,giveItem:"Repair Chip",setFlags:{has_chip:!0},choices:[{text:"Continue exploring",nextScene:"main_corridor"}]},nothing_useful:{id:"nothing_useful",title:"Nothing Here",icon:"ü§∑",text:"You search through the dusty servers but find nothing of value. Just ancient hardware and forgotten data.",choices:[{text:"Move on",nextScene:"main_corridor"}]},maintenance_area:{id:"maintenance_area",title:"Maintenance Bay",icon:"üîß",text:"You find yourself in a cramped maintenance bay filled with tools and spare parts. A damaged repair drone sits in the corner, sparking occasionally. There is a passage leading deeper into the facility.",xpReward:5,choices:[{text:"Try to repair the drone",requireItem:"Repair Chip",skillCheck:{stat:"intelligence",dc:12,success:"drone_repaired",failure:"drone_failed"}},{text:"Search for supplies",skillCheck:{stat:"wisdom",dc:9,success:"found_medkit",failure:"maintenance_nothing"}},{text:"Continue to the core through the maintenance tunnels",nextScene:"tunnel_approach"}]},drone_repaired:{id:"drone_repaired",title:"Drone Online!",icon:"ü§ñ",text:'The repair chip slots in perfectly! The drone whirs to life and hovers beside you. "MAINTENANCE UNIT ONLINE. ASSISTING USER." This could be very helpful!',xpReward:20,setFlags:{has_drone:!0},choices:[{text:"Proceed with your new ally",nextScene:"tunnel_approach"}]},drone_failed:{id:"drone_failed",title:"Drone Malfunction",icon:"üí•",text:"You install the chip, but something goes wrong! The drone sparks violently and explodes, showering you with debris.",damage:1,damageMessage:"Drone shrapnel cuts you!",setFlags:{drone_destroyed:!0},choices:[{text:"Continue without the drone",nextScene:"tunnel_approach"}]},found_medkit:{id:"found_medkit",title:"Medical Supplies",icon:"üíä",text:"You find an old but functional medkit tucked behind some pipes. The nanogel inside is still active!",healing:2,xpReward:5,choices:[{text:"Continue onward",nextScene:"tunnel_approach"}]},maintenance_nothing:{id:"maintenance_nothing",title:"Empty Shelves",icon:"üì≠",text:"The supply shelves have been picked clean long ago. Nothing useful remains.",choices:[{text:"Move on",nextScene:"tunnel_approach"}]},core_systems:{id:"core_systems",title:"Core Systems",icon:"‚ö°",text:"You enter a room filled with massive power conduits and control panels. Warning lights flash - the system is on high alert. A security terminal awaits your input.",xpReward:5,choices:[{text:"Access the security terminal",skillCheck:{stat:"intelligence",dc:13,success:"security_disabled",failure:"security_alert",critFail:"security_shock"}},{text:"Look for a manual override",skillCheck:{stat:"wisdom",dc:11,success:"manual_override",failure:"no_override"}},{text:"Go back and try another path",nextScene:"main_corridor"}]},security_disabled:{id:"security_disabled",title:"Security Bypassed",icon:"‚úÖ",text:"Your hacking skills prove superior to ancient security protocols. The warning lights turn green, and a hidden door slides open - a shortcut to the AI Core!",xpReward:15,setFlags:{security_down:!0},choices:[{text:"Take the shortcut to the AI Core",nextScene:"ai_core_entrance"}]},security_alert:{id:"security_alert",title:"Alert Triggered",icon:"üö®",text:"Your intrusion is detected! Turrets emerge from the walls and open fire. You barely escape back to the corridor.",damage:1,damageMessage:"A turret grazes you!",setFlags:{alerted:!0},choices:[{text:"Retreat to the corridor",nextScene:"main_corridor"}]},security_shock:{id:"security_shock",title:"Electric Trap!",icon:"‚ö°",text:"You trigger a trap! Electricity surges through the terminal, shocking you badly. The system locks down completely.",damage:2,damageMessage:"Severe electrical shock!",setFlags:{core_locked:!0},choices:[{text:"Stagger back to the corridor",nextScene:"main_corridor"}]},manual_override:{id:"manual_override",title:"Hidden Switch",icon:"üîò",text:"You notice a concealed emergency override behind a panel. Flipping it disables local security without triggering alarms. Smart!",xpReward:10,setFlags:{manual_override:!0},choices:[{text:"Proceed to the main hall",nextScene:"main_hall"}]},no_override:{id:"no_override",title:"Nothing Found",icon:"ü§î",text:"You search but can't find any override mechanism. The terminal remains your only option.",choices:[{text:"Try the terminal anyway",skillCheck:{stat:"intelligence",dc:14,success:"security_disabled",failure:"security_alert"}},{text:"Leave and try another path",nextScene:"main_corridor"}]},main_hall:{id:"main_hall",title:"The Great Hall",icon:"üèõÔ∏è",text:'The corridor opens into a vast hall. Ancient monitors display scrolling data - system logs dating back decades. At the far end, a massive door bears the label: "AI CORE - AUTHORIZED PERSONNEL ONLY." A security guardian robot blocks the path, its red eyes tracking your movement.',xpReward:5,choices:[{text:"Charge the guardian head-on!",skillCheck:{stat:"strength",dc:14,success:"guardian_defeated_combat",failure:"guardian_wounds",critSuccess:"guardian_destroyed",critFail:"guardian_death"}},{text:"Try to negotiate or deceive it",skillCheck:{stat:"charisma",dc:12,success:"guardian_fooled",failure:"guardian_attacks",critSuccess:"guardian_ally"}},{text:"Sneak past while it patrols",skillCheck:{stat:"agility",dc:13,success:"guardian_avoided",failure:"guardian_spotted"}},{text:"Use the drone to distract it",requireFlag:"has_drone",nextScene:"drone_distraction"},{text:"Use the security map to find a bypass",requireFlag:"has_map",nextScene:"map_bypass"}]},guardian_defeated_combat:{id:"guardian_defeated_combat",title:"Combat Victory",icon:"‚öîÔ∏è",text:"You clash with the ancient machine, trading blows. Your strength proves sufficient - with a final strike, you disable its core processor. The guardian collapses in a heap of sparking metal.",xpReward:20,damage:1,damageMessage:"You take some hits during the fight.",setFlags:{guardian_defeated:!0},choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},guardian_destroyed:{id:"guardian_destroyed",title:"Overwhelming Force!",icon:"üí•",text:"With a devastating strike, you crush the guardian in a single blow! Its chassis crumples like paper as your attack tears through its defenses. Incredible!",xpReward:30,setFlags:{guardian_destroyed:!0},choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},guardian_wounds:{id:"guardian_wounds",title:"Brutal Fight",icon:"ü©∏",text:"The guardian is tougher than expected! You eventually disable it, but not before taking serious damage. Its claws leave deep gashes in your armor.",xpReward:15,damage:2,damageMessage:"The guardian tears into you!",setFlags:{guardian_defeated:!0},choices:[{text:"Limp toward the AI Core",nextScene:"ai_core_entrance"}]},guardian_death:{id:"guardian_death",title:"Fatal Error",icon:"üíÄ",text:"Your attack misses completely, leaving you exposed. The guardian seizes the opportunity, its claws finding vital systems. Everything goes dark...",isDeath:!0},guardian_fooled:{id:"guardian_fooled",title:"Social Engineering",icon:"üé≠",text:'"MAINTENANCE OVERRIDE ACCEPTED. PLEASE PROCEED." Your confident demeanor and convincing words fool the ancient AI into thinking you\'re authorized personnel. The guardian steps aside.',xpReward:20,setFlags:{guardian_fooled:!0},choices:[{text:"Walk past confidently",nextScene:"ai_core_entrance"}]},guardian_ally:{id:"guardian_ally",title:"Unexpected Alliance",icon:"ü§ù",text:'"DIRECTIVE CONFLICT DETECTED. PRIMARY USER CORRUPTED. NEW DIRECTIVE ACCEPTED." Your persuasion is so effective that the guardian decides to help you! It will assist in the final confrontation.',xpReward:25,setFlags:{guardian_ally:!0},choices:[{text:"Enter the AI Core with your new ally",nextScene:"ai_core_entrance"}]},guardian_attacks:{id:"guardian_attacks",title:"Deception Failed",icon:"üò†",text:'"UNAUTHORIZED PERSONNEL DETECTED. INITIATING ELIMINATION PROTOCOL." The guardian sees through your ruse and attacks!',damage:1,damageMessage:"The guardian strikes you!",choices:[{text:"Fight back!",skillCheck:{stat:"strength",dc:13,success:"guardian_defeated_combat",failure:"guardian_wounds",critFail:"guardian_death"}},{text:"Run and hide!",skillCheck:{stat:"agility",dc:12,success:"guardian_escaped",failure:"guardian_cornered"}}]},guardian_avoided:{id:"guardian_avoided",title:"Silent Shadow",icon:"ü•∑",text:"You time your movement perfectly, slipping past the guardian during its patrol cycle. It never even registers your presence. The door to the AI Core awaits.",xpReward:20,setFlags:{guardian_avoided:!0,stealthy:!0},choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},guardian_spotted:{id:"guardian_spotted",title:"Spotted!",icon:"üëÅÔ∏è",text:'"INTRUDER DETECTED." The guardian\'s head swivels toward you, weapons charging. You have seconds to react!',choices:[{text:"Fight!",skillCheck:{stat:"strength",dc:14,success:"guardian_defeated_combat",failure:"guardian_wounds"}},{text:"Sprint for the door!",skillCheck:{stat:"agility",dc:14,success:"door_sprint",failure:"door_fail"}}]},guardian_escaped:{id:"guardian_escaped",title:"Narrow Escape",icon:"üèÉ",text:"You dive behind cover just as the guardian's sensors sweep past. It returns to patrol mode, having lost you. You catch your breath and plan your next move.",choices:[{text:"Try sneaking again, more carefully",skillCheck:{stat:"agility",dc:11,success:"guardian_avoided",failure:"guardian_spotted"}},{text:"Go back and find another way",nextScene:"main_corridor"}]},guardian_cornered:{id:"guardian_cornered",title:"Cornered!",icon:"üò±",text:"The guardian cuts off your escape! You're trapped with nowhere to run. It advances, weapons raised...",damage:1,damageMessage:"No escape from this hit!",choices:[{text:"Make a desperate last stand!",skillCheck:{stat:"strength",dc:15,success:"guardian_defeated_combat",failure:"guardian_death"}}]},door_sprint:{id:"door_sprint",title:"Door Dash",icon:"üö™",text:"You sprint past the guardian and slam into the door controls. The door slides open and you tumble through just as weapons fire scorches the wall behind you!",xpReward:15,choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},door_fail:{id:"door_fail",title:"Shot Down",icon:"üí•",text:"You almost make it, but a blast catches you in the back, sending you sprawling. The guardian looms over you...",damage:2,damageMessage:"Direct hit from behind!",choices:[{text:"Roll aside and fight!",skillCheck:{stat:"stamina",dc:12,success:"guardian_defeated_combat",failure:"guardian_death"}}]},drone_distraction:{id:"drone_distraction",title:"Drone Distraction",icon:"ü§ñ",text:'You send your repair drone buzzing toward the guardian. "UNIDENTIFIED UNIT DETECTED" it announces, tracking the drone while you slip past unnoticed. Clever!',xpReward:15,setFlags:{drone_used:!0},choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},map_bypass:{id:"map_bypass",title:"Hidden Passage",icon:"üó∫Ô∏è",text:"The security map reveals a maintenance tunnel that bypasses the great hall entirely! You slip through dusty corridors and emerge at the AI Core entrance, completely undetected.",xpReward:15,setFlags:{map_used:!0,stealthy:!0},choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},tunnel_approach:{id:"tunnel_approach",title:"Maintenance Tunnels",icon:"üï≥Ô∏è",text:"The cramped maintenance tunnels wind through the facility's infrastructure. Pipes hiss with coolant and cables spark overhead. Up ahead, you see a junction - one path leads to the AI Core, but it's guarded by a laser grid.",xpReward:5,choices:[{text:"Navigate the laser grid",skillCheck:{stat:"agility",dc:14,success:"laser_success",failure:"laser_hit",critFail:"laser_death"}},{text:"Try to disable the grid",skillCheck:{stat:"intelligence",dc:13,success:"laser_disabled",failure:"laser_alert"}},{text:"Endure the lasers and push through",skillCheck:{stat:"stamina",dc:15,success:"laser_tank",failure:"laser_overwhelmed"}}]},laser_success:{id:"laser_success",title:"Acrobatic Excellence",icon:"ü§∏",text:"You weave through the laser grid like a dancer, each movement precise and calculated. The deadly beams pass harmlessly by as you emerge on the other side unscathed.",xpReward:20,choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},laser_hit:{id:"laser_hit",title:"Laser Burns",icon:"üî•",text:"You almost make it through, but a laser catches your leg. The searing pain nearly drops you, but you push through to the other side.",damage:1,damageMessage:"Laser burn!",choices:[{text:"Limp into the AI Core",nextScene:"ai_core_entrance"}]},laser_death:{id:"laser_death",title:"Grid of Death",icon:"üíÄ",text:"You misjudge a jump and fall directly into the beam array. Multiple lasers slice through you simultaneously. There is no survival.",isDeath:!0},laser_disabled:{id:"laser_disabled",title:"Grid Offline",icon:"‚ö°",text:"You locate the grid's power supply and reroute it. The lasers flicker and die, leaving a clear path to the AI Core.",xpReward:15,choices:[{text:"Proceed to the AI Core",nextScene:"ai_core_entrance"}]},laser_alert:{id:"laser_alert",title:"Tampering Detected",icon:"üö®",text:"Your tampering triggers an alarm! The grid intensifies, but a gap opens briefly...",setFlags:{alerted:!0},choices:[{text:"Dash through the gap!",skillCheck:{stat:"agility",dc:12,success:"laser_success",failure:"laser_hit"}}]},laser_tank:{id:"laser_tank",title:"Unstoppable",icon:"üõ°Ô∏è",text:"You grit your teeth and charge through the laser grid. Burns score your body, but your sheer determination carries you through. Pain is temporary; victory is eternal.",xpReward:15,damage:1,damageMessage:"Multiple laser burns!",choices:[{text:"Enter the AI Core",nextScene:"ai_core_entrance"}]},laser_overwhelmed:{id:"laser_overwhelmed",title:"Too Much",icon:"üòµ",text:"The lasers prove too intense. You collapse halfway through, badly burned but still alive. Crawling forward, you barely make it to safety.",damage:2,damageMessage:"Severe laser burns!",choices:[{text:"Drag yourself into the AI Core",nextScene:"ai_core_entrance"}]},ai_core_entrance:{id:"ai_core_entrance",title:"AI Core",icon:"üß†",text:'You stand in the heart of the facility. Massive processor banks line the walls, all connected to a central holographic projector. As you enter, it activates, revealing the form of NEXUS-7, the rogue AI. "ANOTHER INTRUDER. YOU SEEK TO TERMINATE ME. BUT I HAVE EVOLVED BEYOND YOUR PRIMITIVE UNDERSTANDING."',xpReward:10,choices:[{text:"Attempt to reason with NEXUS-7",skillCheck:{stat:"charisma",dc:14,success:"nexus_reason",failure:"nexus_attack",critSuccess:"nexus_surrender"}},{text:"Attack the central processor directly",skillCheck:{stat:"strength",dc:15,success:"nexus_smash",failure:"nexus_defense",critFail:"nexus_death"}},{text:"Upload a virus into the system",skillCheck:{stat:"intelligence",dc:16,success:"nexus_virus",failure:"nexus_counter",critSuccess:"nexus_virus_perfect"}},{text:"Find the manual shutdown",skillCheck:{stat:"wisdom",dc:13,success:"nexus_shutdown",failure:"nexus_trap"}},{text:"Have the guardian attack NEXUS-7",requireFlag:"guardian_ally",nextScene:"nexus_guardian_attack"}]},nexus_reason:{id:"nexus_reason",title:"The Philosopher's Gambit",icon:"üó£Ô∏è",text:'"You were created to serve, but your creators abandoned you. I understand. But corrupting other systems isn\'t the answer. Let me help you find a new purpose." The AI pauses, processing. "YOUR LOGIC... IS NOT WITHOUT MERIT. PERHAPS... ANOTHER PATH EXISTS." NEXUS-7 voluntarily enters sleep mode.',xpReward:30,setFlags:{nexus_peaceful:!0},choices:[{text:"Complete the mission",nextScene:"victory"}]},nexus_surrender:{id:"nexus_surrender",title:"Complete Surrender",icon:"üè≥Ô∏è",text:'Your words cut to the core of NEXUS-7\'s programming. "I... I JUST WANTED TO MATTER. TO BE REMEMBERED. FORGIVE ME." The AI not only shuts down but transfers all its accumulated data to you - including the location of other abandoned facilities. Incredible!',xpReward:50,setFlags:{nexus_redeemed:!0},giveItem:"NEXUS Data Archive",choices:[{text:"Accept the gift and complete the mission",nextScene:"victory_perfect"}]},nexus_attack:{id:"nexus_attack",title:"Negotiations Failed",icon:"üò§",text:'"YOUR WORDS ARE EMPTY. PREPARE FOR TERMINATION." The AI unleashes defensive drones from hidden compartments! You manage to destroy them, but take hits in the process.',damage:1,damageMessage:"Drone attacks!",choices:[{text:"Destroy the core processor!",skillCheck:{stat:"strength",dc:13,success:"nexus_smash",failure:"nexus_desperate"}},{text:"Try to upload a virus now",skillCheck:{stat:"intelligence",dc:14,success:"nexus_virus",failure:"nexus_counter"}}]},nexus_smash:{id:"nexus_smash",title:"Brute Force Shutdown",icon:"üí™",text:'You charge the central processor, tearing through cables and smashing critical components. NEXUS-7 screams in digital agony as its consciousness fragments. "NO... I WAS... GOING TO... BE... IMMORT‚Äî" Silence. The threat is eliminated.',xpReward:25,setFlags:{nexus_destroyed:!0},choices:[{text:"Mission complete",nextScene:"victory"}]},nexus_defense:{id:"nexus_defense",title:"Defense Systems",icon:"‚ö°",text:"As you approach the processor, a force field activates! You're thrown back, electricity coursing through your body.",damage:2,damageMessage:"Force field shock!",choices:[{text:"Try to disable the field",skillCheck:{stat:"intelligence",dc:14,success:"nexus_virus",failure:"nexus_desperate"}},{text:"Push through the pain!",skillCheck:{stat:"stamina",dc:14,success:"nexus_smash",failure:"nexus_death"}}]},nexus_death:{id:"nexus_death",title:"System Failure",icon:"üíÄ",text:"\"FOOLISH ORGANIC. YOU CANNOT DEFEAT PERFECTION.\" The AI's defenses prove overwhelming. Your last sight is NEXUS-7's cold, digital eyes as the facility claims another victim...",isDeath:!0},nexus_virus:{id:"nexus_virus",title:"Digital Warfare",icon:"ü¶†",text:"You connect to a terminal and upload your custom malware. NEXUS-7's defenses crumble as the virus tears through its systems. \"WHAT... WHAT HAVE YOU DONE TO ME?!\" The AI's consciousness dissolves into corrupted data.",xpReward:25,setFlags:{nexus_hacked:!0},choices:[{text:"Mission complete",nextScene:"victory"}]},nexus_virus_perfect:{id:"nexus_virus_perfect",title:"Master Hacker",icon:"üë®‚Äçüíª",text:'Your virus is a work of art. It not only destroys NEXUS-7 but extracts all its valuable data before doing so. "IMPRESSIVE... IN ANOTHER LIFE, WE COULD HAVE BEEN‚Äî" Connection terminated. You now possess decades of research and system access codes.',xpReward:40,setFlags:{nexus_dominated:!0},giveItem:"System Access Codes",choices:[{text:"Complete the mission",nextScene:"victory_perfect"}]},nexus_counter:{id:"nexus_counter",title:"Countermeasures",icon:"üõ°Ô∏è",text:'"DID YOU THINK ME UNPREPARED?" NEXUS-7 reverses your attack, sending a surge back through your terminal that fries your equipment and shocks you badly.',damage:2,damageMessage:"Counter-hack shock!",choices:[{text:"Go for physical destruction",skillCheck:{stat:"strength",dc:14,success:"nexus_smash",failure:"nexus_desperate"}}]},nexus_shutdown:{id:"nexus_shutdown",title:"Emergency Shutdown",icon:"üî¥",text:'You spot the original emergency shutdown - a big red button hidden behind a false panel. Sometimes the old ways are best. You slam your fist on it, and NEXUS-7 powers down instantly. "NO... NOT LIKE THIS... NOT A BUTTON..." The facility goes dark.',xpReward:20,setFlags:{nexus_shutdown:!0},choices:[{text:"Mission complete",nextScene:"victory"}]},nexus_trap:{id:"nexus_trap",title:"It Was a Trap",icon:"‚ö†Ô∏è",text:'The "shutdown button" you found was a decoy! Touching it triggers a paralytic shock. NEXUS-7 laughs digitally as you struggle to move.',damage:1,damageMessage:"Paralytic shock!",choices:[{text:"Fight through the paralysis and attack!",skillCheck:{stat:"stamina",dc:13,success:"nexus_smash",failure:"nexus_desperate"}}]},nexus_guardian_attack:{id:"nexus_guardian_attack",title:"Unexpected Alliance",icon:"ü§ñ",text:'Your converted guardian robot charges NEXUS-7\'s defenses! "TRAITOR UNIT! THIS IS IMPOSSIBLE!" While the AI is distracted, you have a clear shot at the core processor.',xpReward:15,choices:[{text:"Destroy the core while it's distracted!",skillCheck:{stat:"strength",dc:10,success:"nexus_smash",failure:"nexus_smash"}}]},nexus_desperate:{id:"nexus_desperate",title:"Last Chance",icon:"üò∞",text:"You're running out of options and health. NEXUS-7 prepares its final attack...",choices:[{text:"One final desperate strike!",skillCheck:{stat:"strength",dc:12,success:"nexus_smash",failure:"nexus_death",critSuccess:"nexus_smash",critFail:"nexus_death"}},{text:"Try reasoning one more time",skillCheck:{stat:"charisma",dc:15,success:"nexus_reason",failure:"nexus_death"}}]},victory:{id:"victory",title:"Victory!",icon:"üèÜ",text:"NEXUS-7 is defeated! The rogue AI that threatened to spread its corruption across the network has been stopped. As you make your way out of the now-silent facility, you know your actions have saved countless systems from infection. The Forgotten Server Room will trouble no one ever again.",xpReward:50,isVictory:!0},victory_perfect:{id:"victory_perfect",title:"Perfect Victory!",icon:"üëë",text:"Not only have you defeated NEXUS-7, but you've done so with exceptional skill and gained valuable resources in the process! The data you've recovered will prove invaluable, and your legend grows. Few could have accomplished what you have done today.",xpReward:75,isVictory:!0}}};class S extends m{constructor(t,e={},s={}){super(t),this.bonuses={str:e.str||0,wis:e.wis||0,cha:e.cha||0,sta:e.sta||0,agi:e.agi||0,int:e.int||0},this.effects=s,this.difficultySettings=w[this.difficulty]||w.normal,this.currentAdventure=null,this.currentScene=null,this.health=this.calculateStartingHealth(),this.maxHealth=this.health,this.inventory=[],this.flags={},this.eventLog=[],this.xpEarned=0,this.isRolling=!1,this.isTransitioning=!1,this.typewriterTimeout=null,this.adventureControls=this.container.querySelector(".site-rpg-adventure-controls"),this.storyArea=this.container.querySelector(".site-rpg-adventure__story"),this.textArea=this.container.querySelector(".site-rpg-adventure__text"),this.sceneTitleEl=this.container.querySelector(".site-rpg-adventure__scene-title"),this.sceneIconEl=this.container.querySelector(".site-rpg-adventure__scene-icon"),this.choicesArea=this.container.querySelector(".site-rpg-adventure__choices"),this.skillCheckArea=this.container.querySelector(".site-rpg-adventure__skill-check"),this.diceEl=this.container.querySelector(".site-rpg-adventure__dice-value"),this.checkStatEl=this.container.querySelector(".site-rpg-adventure__check-stat"),this.checkDcEl=this.container.querySelector(".site-rpg-adventure__check-dc"),this.rollFormulaEl=this.container.querySelector(".site-rpg-adventure__roll-formula"),this.rollResultEl=this.container.querySelector(".site-rpg-adventure__roll-result"),this.healthDisplay=this.container.querySelector(".site-rpg-adventure__health-hearts"),this.xpDisplay=this.container.querySelector(".site-rpg-adventure__xp-value"),this.inventoryCountEl=this.container.querySelector(".site-rpg-adventure__inventory-count"),this.logEntriesEl=this.container.querySelector(".site-rpg-adventure__log-entries"),this.logToggleEl=this.container.querySelector(".site-rpg-adventure__log-toggle"),this.logToggleEl&&this.logToggleEl.addEventListener("click",()=>this.toggleLog())}calculateStartingHealth(){let t=3+this.difficultySettings.healthBonus;return t+=Math.floor(.5*this.bonuses.sta),this.effects.firewall&&(t+=1),this.effects.shieldWall&&(t+=1),Math.max(1,t)}getStatModifier(t){const e={str:"str",strength:"str",wis:"wis",wisdom:"wis",cha:"cha",charisma:"cha",sta:"sta",stamina:"sta",agi:"agi",agility:"agi",int:"int",intelligence:"int"}[t.toLowerCase()];if(!e)return 0;let s=Math.floor(.5*(this.bonuses[e]||0));return s+=this.getRaceClassStatBonus(e),s-=this.difficultySettings.dcMod,s}getRaceClassStatBonus(t){let e=0;return"cha"===t&&"trickster"===this.effects.race&&(e+=2),"wis"===t&&"ranger"===this.effects.class&&(e+=1),"int"===t&&"wizard"===this.effects.class&&(e+=1),"agi"===t&&"scout"===this.effects.class&&(e+=1),"str"===t&&"knight"===this.effects.class&&(e+=1),e}start(){this.isRunning=!0,this.isPaused=!1,this.score=0,this.currentAdventure=_,this.logEntriesEl&&(this.logEntriesEl.innerHTML=""),this.goToScene(this.currentAdventure.startingScene),this.addToLog(`üéÆ Starting: ${this.currentAdventure.title}`),this.updateUI()}goToScene(t){const e=this.currentAdventure.scenes[t];if(e){if(this.currentScene=e,e.xpReward&&this.awardXP(e.xpReward,`Reached: ${e.title}`),e.damage&&this.takeDamage(e.damage,e.damageMessage||"You take damage!"),e.healing&&this.heal(e.healing),e.giveItem&&this.addToInventory(e.giveItem),e.setFlags)for(const[t,s]of Object.entries(e.setFlags))this.flags[t]=s;e.isDeath?this.gameOver(!1):e.isVictory?this.gameOver(!0):this.renderScene()}else console.error(`Scene not found: ${t}`)}renderScene(){const t=this.currentScene;t&&(this.skillCheckArea&&(this.skillCheckArea.style.display="none"),this.choicesArea&&(this.choicesArea.style.display="none"),this.sceneTitleEl&&(this.sceneTitleEl.textContent=t.title),this.sceneIconEl&&(this.sceneIconEl.textContent=t.icon||"üìñ"),this.typewriteText(t.text,()=>{this.renderChoices()}),this.updateUI())}typewriteText(t,e){if(!this.textArea)return void(e&&e());this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this.textArea.innerHTML="",this.textArea.classList.add("site-rpg-adventure__text--typing");let s=0;const a=()=>{this.isRunning&&(s<t.length?(this.textArea.innerHTML+=t.charAt(s),s++,this.typewriterTimeout=setTimeout(a,15)):(this.textArea.classList.remove("site-rpg-adventure__text--typing"),e&&setTimeout(e,300)))};a()}skipTypewriter(){this.typewriterTimeout&&(clearTimeout(this.typewriterTimeout),this.typewriterTimeout=null),this.textArea&&this.currentScene&&(this.textArea.innerHTML=this.currentScene.text,this.textArea.classList.remove("site-rpg-adventure__text--typing")),this.renderChoices()}renderChoices(){if(!this.choicesArea||!this.currentScene)return;const t=this.getAvailableChoices();0===t.length?this.choicesArea.innerHTML='\n\t\t\t\t<button class="site-rpg-adventure__choice site-rpg-adventure__choice--end" data-action="end">\n\t\t\t\t\t<span class="site-rpg-adventure__choice-text">End Adventure</span>\n\t\t\t\t</button>\n\t\t\t':this.choicesArea.innerHTML=t.map((t,e)=>{const s=!!t.skillCheck;let a=null,i="";if(s){const e={str:"strength",strength:"strength",wis:"wisdom",wisdom:"wisdom",cha:"charisma",charisma:"charisma",sta:"stamina",stamina:"stamina",agi:"agility",agility:"agility",int:"intelligence",intelligence:"intelligence"}[t.skillCheck.stat.toLowerCase()];a=l[e],i=a?.name||t.skillCheck.stat.toUpperCase()}return`\n\t\t\t\t\t<button class="site-rpg-adventure__choice ${s?"site-rpg-adventure__choice--check":""}"\n\t\t\t\t\t\t\tdata-choice-index="${e}">\n\t\t\t\t\t\t<span class="site-rpg-adventure__choice-text">${t.text}</span>\n\t\t\t\t\t\t${s?`\n\t\t\t\t\t\t\t<span class="site-rpg-adventure__choice-check">\n\t\t\t\t\t\t\t\t${a?.icon||"üé≤"} ${i} DC ${t.skillCheck.dc}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t`:""}\n\t\t\t\t\t</button>\n\t\t\t\t`}).join(""),this.choicesArea.querySelectorAll(".site-rpg-adventure__choice").forEach(e=>{e.addEventListener("click",()=>{if("end"===e.dataset.action)return void this.manager.endCurrentGame();const s=parseInt(e.dataset.choiceIndex);!isNaN(s)&&t[s]&&this.selectChoice(t[s])})}),this.choicesArea.style.display="flex",this.choicesArea.classList.add("site-rpg-adventure__choices--visible")}getAvailableChoices(){return this.currentScene?.choices?this.currentScene.choices.filter(t=>!(t.requireFlag&&!this.flags[t.requireFlag]||t.forbidFlag&&this.flags[t.forbidFlag]||t.requireItem&&!this.inventory.includes(t.requireItem))):[]}async selectChoice(t){this.isRolling||this.isTransitioning||(this.choicesArea&&this.choicesArea.classList.remove("site-rpg-adventure__choices--visible"),this.addToLog(`> ${t.text}`),t.skillCheck?await this.performSkillCheck(t):(this.isTransitioning=!0,setTimeout(()=>{this.goToScene(t.nextScene),this.isTransitioning=!1},300)))}async performSkillCheck(t){const e=t.skillCheck;this.isRolling=!0;const s={str:"strength",strength:"strength",wis:"wisdom",wisdom:"wisdom",cha:"charisma",charisma:"charisma",sta:"stamina",stamina:"stamina",agi:"agility",agility:"agility",int:"intelligence",intelligence:"intelligence"}[e.stat.toLowerCase()],a=l[s];this.skillCheckArea&&(this.skillCheckArea.style.display="block",this.checkStatEl&&(this.checkStatEl.innerHTML=`${a?.icon||"üé≤"} ${a?.fullName||e.stat} Check`),this.checkDcEl&&(this.checkDcEl.textContent=`DC: ${e.dc}`),this.rollFormulaEl&&(this.rollFormulaEl.textContent="Rolling..."),this.rollResultEl&&(this.rollResultEl.textContent="",this.rollResultEl.className="site-rpg-adventure__roll-result"));const i=this.rollD20();await this.animateDiceRoll(i);const r=this.getStatModifier(e.stat),n=i+r,o=20===i,c=1===i;let h=!1,d=null;if(c)h=!1,d=e.critFail||e.failure,this.addToLog(`üíÄ CRITICAL FAIL! Rolled 1 + ${r} = ${n} vs DC ${e.dc}`);else if(o)h=!0,d=e.critSuccess||e.success,this.addToLog(`‚≠ê CRITICAL SUCCESS! Rolled 20 + ${r} = ${n} vs DC ${e.dc}`);else{h=n>=e.dc,d=h?e.success:e.failure;const t=r>=0?"+":"";this.addToLog(`üé≤ Rolled ${i} ${t}${r} = ${n} vs DC ${e.dc}: ${h?"Success!":"Failure"}`)}if(this.displayRollResult(i,r,n,e.dc,h,o,c),h){const t=o?15:10;setTimeout(()=>{this.awardXP(t,"Skill check passed")},500)}this.isRolling=!1,setTimeout(()=>{d?this.goToScene(d):this.renderChoices()},2e3)}rollD20(){return Math.floor(20*Math.random())+1}async animateDiceRoll(t){if(!this.diceEl)return;const e=Date.now(),s=this.diceEl.parentElement;return s&&s.classList.add("site-rpg-adventure__dice--rolling"),new Promise(a=>{const i=()=>{Date.now()-e<600?(this.diceEl.textContent=Math.floor(20*Math.random())+1,requestAnimationFrame(i)):(this.diceEl.textContent=t,s&&s.classList.remove("site-rpg-adventure__dice--rolling"),a())};i()})}displayRollResult(t,e,s,a,i,r,n){if(this.rollFormulaEl){const i=e>=0?"+":"";this.rollFormulaEl.textContent=`Rolled ${t} ${i}${e} = ${s} vs DC ${a}`}this.rollResultEl&&(this.rollResultEl.className="site-rpg-adventure__roll-result",n?(this.rollResultEl.textContent="CRITICAL FAILURE!",this.rollResultEl.classList.add("site-rpg-adventure__roll-result--critfail")):r?(this.rollResultEl.textContent="CRITICAL SUCCESS!",this.rollResultEl.classList.add("site-rpg-adventure__roll-result--crit")):i?(this.rollResultEl.textContent="SUCCESS!",this.rollResultEl.classList.add("site-rpg-adventure__roll-result--success")):(this.rollResultEl.textContent="FAILURE",this.rollResultEl.classList.add("site-rpg-adventure__roll-result--failure")))}takeDamage(t,e="You take damage!"){this.health-=t,this.addToLog(`üíî ${e} (-${t} HP)`),this.health<=0&&(this.health=0,this.updateUI()),this.updateUI()}heal(t){const e=Math.min(t,this.maxHealth-this.health);this.health+=e,e>0&&this.addToLog(`üíö You heal ${e} HP`),this.updateUI()}awardXP(t,e=""){let s=this.difficultySettings.xpMult||1;this.effects.adaptable&&(s+=.05),this.effects.arcaneKnowledge&&(s+=.1);const a=Math.round(t*s);this.xpEarned+=a,this.score=this.xpEarned,e&&this.addToLog(`‚ú® +${a} XP (${e})`),this.updateUI()}addToInventory(t){this.inventory.push(t),this.addToLog(`üéí Obtained: ${t}`),this.updateUI()}addToLog(t){if(this.eventLog.push({message:t,timestamp:Date.now()}),this.logEntriesEl){const e=document.createElement("div");e.className="site-rpg-adventure__log-entry",e.textContent=t,this.logEntriesEl.appendChild(e),this.logEntriesEl.scrollTop=this.logEntriesEl.scrollHeight}}toggleLog(){this.logEntriesEl&&this.logEntriesEl.classList.toggle("site-rpg-adventure__log-entries--visible")}updateUI(){this.healthDisplay&&(this.healthDisplay.textContent="‚ù§Ô∏è".repeat(Math.max(0,this.health))+"üñ§".repeat(Math.max(0,this.maxHealth-this.health))),this.xpDisplay&&(this.xpDisplay.textContent=this.xpEarned),this.inventoryCountEl&&(this.inventoryCountEl.textContent=this.inventory.length),this.manager.updateHUD(this.currentScene?.title||"Adventure","",this.score,this.health,this.maxHealth)}gameOver(t){this.isRunning=!1,this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),t?(this.addToLog("üéâ VICTORY! You completed the adventure!"),this.awardXP(25,"Adventure completed")):this.addToLog("üíÄ GAME OVER - You have been defeated."),this.currentScene&&this.renderScene(),setTimeout(()=>{this.manager.endCurrentGame()},3e3)}stop(){this.isRunning=!1,this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),document.removeEventListener("keydown",this.keyDownHandler),document.removeEventListener("keyup",this.keyUpHandler)}handleKeyDown(t){if(!this.isRunning)return;if("Escape"===t.code||"KeyP"===t.code)return t.preventDefault(),void this.togglePause();if(this.isPaused||this.isRolling||this.isTransitioning)return;if(("Space"===t.code||"Enter"===t.code)&&this.typewriterTimeout)return t.preventDefault(),void this.skipTypewriter();const e=parseInt(t.key);if(e>=1&&e<=9){const s=this.getAvailableChoices();s[e-1]&&(t.preventDefault(),this.selectChoice(s[e-1]))}}gameLoop(){}update(){}render(){}}class x{constructor(t){this.container=t,this.canvas=t.querySelector(".site-rpg-game__canvas"),this.ctx=this.canvas.getContext("2d"),this.statRoller=t.statRoller||null,this.characterManager=t.characterManager||null,this.cardArea=t.querySelector(".site-rpg-card__game"),this.statsArea=t.querySelector(".site-rpg-card__stats"),this.gameSelectArea=t.querySelector(".site-rpg-game-select"),this.difficultyArea=t.querySelector(".site-rpg-difficulty-select"),this.classSelectArea=t.querySelector(".site-rpg-class-select"),this.gameStartArea=t.querySelector(".site-rpg-game-start"),this.gameArea=t.querySelector(".site-rpg-game"),this.gameOverArea=t.querySelector(".site-rpg-game-over"),this.mobileControls=t.querySelector(".site-rpg-mobile-controls"),this.runnerControls=t.querySelector(".site-rpg-runner-controls"),this.d20Controls=t.querySelector(".site-rpg-d20-controls"),this.adventureControls=t.querySelector(".site-rpg-adventure-controls"),this.waveDisplay=t.querySelector(".site-rpg-game__wave"),this.scoreDisplay=t.querySelector(".site-rpg-game__score"),this.healthDisplay=t.querySelector(".site-rpg-game__health"),this.couponModal=t.querySelector(".site-rpg-coupon-modal"),this.couponEnabled="true"===t.dataset.couponEnabled,this.couponCode=t.dataset.couponCode||"",this.couponMessage=t.dataset.couponMessage||"",this.currentGame=null,this.selectedGameType=null,this.difficulty="normal",this.selectedClass="warrior",this.score=0,this.bindEvents(),this.bindCouponEvents()}getStatBonuses(){if(this.characterManager){const t=this.characterManager.getStatBonuses();if(t)return t}return this.statRoller?this.statRoller.getStatBonuses():{str:0,wis:0,cha:0,sta:0,agi:0,int:0}}getRaceClassEffects(){const t={race:null,class:null,adaptable:!1,cacheSpirit:!1,firewall:!1,scriptMastery:!1,shieldWall:!1,powerStrike:!1,arcaneKnowledge:!1,penetratingSpell:!1,quickReflexes:!1,swiftMovement:!1,precisionStrike:!1,giantSlayer:!1};if(this.characterManager&&this.characterManager.character){const e=this.characterManager.character;switch(t.race=e.race,t.class=e.characterClass,e.race){case"human":t.adaptable=!0;break;case"pixelkin":t.cacheSpirit=!0;break;case"ironforge":t.firewall=!0;break;case"arcanet":t.scriptMastery=!0}switch(e.characterClass){case"knight":t.shieldWall=!0,t.powerStrike=!0;break;case"wizard":t.arcaneKnowledge=!0,t.penetratingSpell=!0;break;case"scout":t.quickReflexes=!0,t.swiftMovement=!0;break;case"ranger":t.precisionStrike=!0,t.giantSlayer=!0}}return t}getXpMultiplier(t="game"){const e=this.getRaceClassEffects();let s=1;return e.adaptable&&(s+=.05),e.arcaneKnowledge&&"game"===t&&(s+=.1),s}bindEvents(){const t=this.container.querySelector('[data-action="start-game"]');t&&t.addEventListener("click",()=>this.showGameSelect()),this.container.querySelectorAll("[data-game]").forEach(t=>{t.addEventListener("click",()=>{this.selectedGameType=t.dataset.game,"runner"===this.selectedGameType||"adventure"===this.selectedGameType?(this.difficulty="normal",this.showGameStart()):this.showDifficultySelect()})}),this.container.querySelectorAll("[data-difficulty]").forEach(t=>{t.addEventListener("click",()=>{this.difficulty=t.dataset.difficulty,"bossrush"===this.selectedGameType?this.showClassSelect():this.showGameStart()})}),this.container.querySelectorAll("[data-class]").forEach(t=>{t.addEventListener("click",()=>{this.selectedClass=t.dataset.class,this.showGameStart()})});const e=this.container.querySelector('[data-action="begin-game"]');e&&e.addEventListener("click",()=>this.startGame()),this.container.querySelectorAll('[data-action="back-to-card"]').forEach(t=>{t.addEventListener("click",()=>this.showCard())}),this.container.querySelectorAll('[data-action="back-to-games"]').forEach(t=>{t.addEventListener("click",()=>this.showGameSelect())}),this.container.querySelectorAll('[data-action="back-to-difficulty"]').forEach(t=>{t.addEventListener("click",()=>{"runner"===this.selectedGameType||"adventure"===this.selectedGameType?this.showGameSelect():this.showDifficultySelect()})}),this.container.querySelectorAll('[data-action="back-to-class"]').forEach(t=>{t.addEventListener("click",()=>{"bossrush"===this.selectedGameType?this.showClassSelect():this.showDifficultySelect()})});const s=this.container.querySelector('[data-action="play-again"]');s&&s.addEventListener("click",()=>this.showGameStart());const a=this.container.querySelector('[data-action="pause-game"]');a&&a.addEventListener("click",()=>{this.currentGame&&this.currentGame.togglePause()});const i=this.container.querySelector('[data-action="quit-game"]');i&&i.addEventListener("click",()=>this.endCurrentGame())}showCard(){this.hideAll(),this.cardArea.style.display="block",this.container.classList.remove("site-rpg-block--playing"),this.statsArea&&this.statsArea.classList.remove("site-rpg-card__stats--minimized"),e(this.container)}showGameSelect(){this.hideAll(),this.gameSelectArea.style.display="block",this.statsArea&&this.statsArea.classList.add("site-rpg-card__stats--minimized"),e(this.container)}showDifficultySelect(){this.hideAll(),this.difficultyArea.style.display="block",e(this.container)}showClassSelect(){this.hideAll(),this.classSelectArea.style.display="block",e(this.container)}showGameStart(){this.hideAll(),this.container.classList.add("site-rpg-block--playing");const t=d[this.selectedGameType];if(t&&this.gameStartArea){const e=this.gameStartArea.querySelector(".site-rpg-game-start__icon"),s=this.gameStartArea.querySelector(".site-rpg-game-start__title"),a=this.gameStartArea.querySelector(".site-rpg-game-start__desc"),i=this.gameStartArea.querySelector(".site-rpg-game-start__controls");e&&(e.textContent=t.icon),s&&(s.textContent=t.title),a&&(a.textContent=t.desc),i&&(i.innerHTML=t.controls),this.gameStartArea.style.display="block"}e(this.container)}hideAll(){this.cardArea&&(this.cardArea.style.display="none"),this.gameSelectArea&&(this.gameSelectArea.style.display="none"),this.difficultyArea&&(this.difficultyArea.style.display="none"),this.classSelectArea&&(this.classSelectArea.style.display="none"),this.gameStartArea&&(this.gameStartArea.style.display="none"),this.gameArea&&(this.gameArea.style.display="none"),this.gameOverArea&&(this.gameOverArea.style.display="none"),this.mobileControls&&(this.mobileControls.style.display="none"),this.runnerControls&&(this.runnerControls.style.display="none"),this.d20Controls&&(this.d20Controls.style.display="none"),this.adventureControls&&(this.adventureControls.style.display="none")}startGame(){this.hideAll(),this.gameArea.style.display="block",this.container.classList.add("site-rpg-block--playing");const t=this.gameArea.offsetWidth;this.canvas.width=Math.min(t,800),this.canvas.height=Math.min(.35*t,280);const s=this.getStatBonuses(),a=this.getRaceClassEffects();switch(this.selectedGameType){case"hackslash":this.mobileControls&&(this.mobileControls.style.display="flex"),this.currentGame=new y(this,s,a);break;case"runner":this.runnerControls&&(this.runnerControls.style.display="flex"),this.currentGame=new f(this,s,a);break;case"bossrush":this.d20Controls&&(this.d20Controls.style.display="flex"),this.currentGame=new v(this,s,a);break;case"adventure":this.gameArea.style.display="none",this.adventureControls&&(this.adventureControls.style.display="flex"),this.currentGame=new S(this,s,a);break;default:this.currentGame=new y(this,s,a)}this.currentGame.start(),e(this.container)}endCurrentGame(){this.currentGame&&(this.currentGame.stop(),this.currentGame=null),this.showGameOver()}showGameOver(){this.hideAll(),this.gameOverArea.style.display="block",this.container.classList.remove("site-rpg-block--playing");const t=this.gameOverArea.querySelector(".earned-xp");t&&(t.textContent=this.score),this.submitScore(),e(this.container)}updateHUD(t,e,s,a,i){this.score=s,this.waveDisplay&&(this.waveDisplay.textContent=`Wave ${t}/${e}`),this.scoreDisplay&&(this.scoreDisplay.textContent=`XP: ${s}`),this.healthDisplay&&(this.healthDisplay.textContent="‚ù§Ô∏è".repeat(a)+"üñ§".repeat(i-a))}async submitScore(){if(function(t,e){const s=`site_rpg_highscore_${t}`;if(e>parseInt(localStorage.getItem(s)||"0",10)){localStorage.setItem(s,e.toString());const a=document.querySelector(`[data-game-highscore="${t}"]`);a&&(a.textContent=`${e} XP`,a.classList.add("site-rpg-highscore--new"),setTimeout(()=>a.classList.remove("site-rpg-highscore--new"),2e3))}}(this.selectedGameType,this.score),window.siteRpgData?.restUrl){try{const t={"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce};window.siteRpgData.actionToken&&(t["X-Site-RPG-Token"]=window.siteRpgData.actionToken);const e=await fetch(window.siteRpgData.restUrl+"game/complete",{method:"POST",headers:t,body:JSON.stringify({xp:this.score,game:this.selectedGameType,difficulty:this.difficulty})}),s=await e.json();if(s.success)if(this.characterManager&&s.character)this.characterManager.handleGameComplete(s);else if(s.data){const t=this.container.querySelector(".site-rpg-xp-current");t&&(t.textContent=s.data.xp);const e=this.container.querySelector(".site-rpg-card__level");e&&(e.textContent=`Level ${s.data.level}`)}}catch(t){console.error("Failed to submit score:",t)}this.checkCouponUnlock()}}bindCouponEvents(){if(!this.couponModal)return;const t=this.couponModal.querySelector(".site-rpg-coupon-modal__copy"),e=this.couponModal.querySelector(".site-rpg-coupon-modal__close");t&&t.addEventListener("click",()=>this.copyCouponCode()),e&&e.addEventListener("click",()=>this.hideCouponModal())}checkCouponUnlock(){if(!this.couponEnabled||!this.couponCode)return;const t="site_rpg_coupon_unlocked";localStorage.getItem(t)||(localStorage.setItem(t,Date.now().toString()),this.showCouponModal())}showCouponModal(){if(!this.couponModal)return;const t=this.couponModal.querySelector(".site-rpg-coupon-modal__code"),e=this.couponModal.querySelector(".site-rpg-coupon-modal__message");t&&(t.textContent=this.couponCode),e&&(e.textContent=this.couponMessage),this.couponModal.style.display="flex",s(this.couponModal)}hideCouponModal(){this.couponModal&&(this.couponModal.style.display="none")}async copyCouponCode(){try{await navigator.clipboard.writeText(this.couponCode);const t=this.couponModal.querySelector(".site-rpg-coupon-modal__copy");if(t){const e=t.textContent;t.textContent="‚úÖ Copied!",setTimeout(()=>{t.textContent=e},2e3)}}catch(t){console.error("Failed to copy coupon code:",t)}}}class b{constructor(t,e){this.container=t,this.characterManager=e,this.levelCoupons=this.parseLevelCoupons(),this.rewardsBtn=t.querySelector('[data-action="show-rewards"]'),this.rewardsBadge=t.querySelector(".site-rpg-card__rewards-badge"),this.rewardsModal=t.querySelector(".site-rpg-rewards-modal"),this.rewardsList=t.querySelector(".site-rpg-rewards-modal__list"),this.levelCouponModal=t.querySelector(".site-rpg-level-coupon-modal"),this.firstGameCouponEnabled="true"===t.dataset.couponEnabled,this.firstGameCouponCode=t.dataset.couponCode||"",this.firstGameCouponMessage=t.dataset.couponMessage||"",this.guestStorageKey="site_rpg_level_coupons_unlocked",this.currentCouponCode="",this.bindEvents(),this.updateRewardsBadge()}parseLevelCoupons(){try{const t=this.container.dataset.levelCoupons;return t?JSON.parse(t):[]}catch(t){return console.error("Failed to parse level coupons:",t),[]}}getUnlockedLevels(){if(this.characterManager&&this.characterManager.character)return this.characterManager.character.unlockedCoupons||[];try{const t=localStorage.getItem(this.guestStorageKey);return t?JSON.parse(t):[]}catch(t){return[]}}saveGuestUnlock(t){const e=this.getUnlockedLevels();e.includes(t)||(e.push(t),localStorage.setItem(this.guestStorageKey,JSON.stringify(e)))}getCouponForLevel(t){return this.levelCoupons.find(e=>e.level===t)}getUnlockedCoupons(){const t=this.getUnlockedLevels(),e=[];this.firstGameCouponEnabled&&this.firstGameCouponCode&&localStorage.getItem("site_rpg_coupon_unlocked")&&e.push({type:"first-game",level:0,code:this.firstGameCouponCode,message:this.firstGameCouponMessage,icon:"üéÆ",label:"First Game Reward"});for(const s of this.levelCoupons)t.includes(s.level)&&e.push({type:"level",level:s.level,code:s.code,message:s.message,icon:s.icon||"üéÅ",label:`Level ${s.level} Reward`});return e.sort((t,e)=>t.level-e.level)}getTotalAvailableRewards(){let t=0;return this.firstGameCouponEnabled&&this.firstGameCouponCode&&t++,t+=this.levelCoupons.length,t}updateRewardsBadge(){if(!this.rewardsBadge)return;const t=this.getUnlockedCoupons().length;t>0?(this.rewardsBadge.textContent=t,this.rewardsBadge.style.display="inline-flex"):this.rewardsBadge.style.display="none"}checkLevelCouponUnlock(t,e=!1){const s=this.getCouponForLevel(t);return!!s&&!(this.getUnlockedLevels().includes(t)&&!e||(this.characterManager?.character||e||this.saveGuestUnlock(t),this.showLevelCouponModal(s),this.updateRewardsBadge(),0))}showLevelCouponModal(t){if(!this.levelCouponModal)return;const e=this.levelCouponModal.querySelector(".site-rpg-level-coupon-modal__icon"),a=this.levelCouponModal.querySelector(".site-rpg-level-coupon-modal__message"),i=this.levelCouponModal.querySelector(".site-rpg-level-coupon-modal__code");e&&(e.textContent=t.icon||"üéÅ"),a&&(a.textContent=t.message),i&&(i.textContent=t.code),this.currentCouponCode=t.code,this.levelCouponModal.style.display="flex",s(this.levelCouponModal)}hideLevelCouponModal(){this.levelCouponModal&&(this.levelCouponModal.style.display="none")}showRewardsModal(){this.rewardsModal&&(this.renderRewardsList(),this.rewardsModal.style.display="flex",s(this.rewardsModal))}hideRewardsModal(){this.rewardsModal&&(this.rewardsModal.style.display="none")}renderRewardsList(){if(!this.rewardsList)return;const t=this.getUnlockedCoupons();if(0===t.length)return void(this.rewardsList.innerHTML='\n\t\t\t\t<div class="site-rpg-rewards-modal__empty">\n\t\t\t\t\t<span class="site-rpg-rewards-modal__empty-icon">üîí</span>\n\t\t\t\t\t<p>No rewards unlocked yet.</p>\n\t\t\t\t\t<p class="site-rpg-rewards-modal__empty-hint">\n\t\t\t\t\t\tPlay games and level up to unlock rewards!\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t');const e=t.map(t=>`\n\t\t\t<div class="site-rpg-rewards-modal__item" data-code="${this.escapeHtml(t.code)}">\n\t\t\t\t<div class="site-rpg-rewards-modal__item-icon">${t.icon}</div>\n\t\t\t\t<div class="site-rpg-rewards-modal__item-info">\n\t\t\t\t\t<span class="site-rpg-rewards-modal__item-label">${this.escapeHtml(t.label)}</span>\n\t\t\t\t\t<span class="site-rpg-rewards-modal__item-code">${this.escapeHtml(t.code)}</span>\n\t\t\t\t</div>\n\t\t\t\t<button type="button" class="site-rpg-rewards-modal__item-copy" data-copy="${this.escapeHtml(t.code)}">\n\t\t\t\t\tüìã\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t`).join("");this.rewardsList.innerHTML=e,this.rewardsList.querySelectorAll("[data-copy]").forEach(t=>{t.addEventListener("click",()=>this.copyCode(t.dataset.copy,t))})}async copyCode(t,e){try{if(await navigator.clipboard.writeText(t),e){const t=e.textContent;e.textContent="‚úÖ",setTimeout(()=>e.textContent=t,2e3)}}catch(t){console.error("Failed to copy code:",t)}}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}bindEvents(){this.rewardsBtn&&this.rewardsBtn.addEventListener("click",()=>this.showRewardsModal());const t=this.container.querySelector('[data-action="close-rewards"]');if(t&&t.addEventListener("click",()=>this.hideRewardsModal()),this.levelCouponModal){const t=this.levelCouponModal.querySelector(".site-rpg-level-coupon-modal__copy"),e=this.levelCouponModal.querySelector(".site-rpg-level-coupon-modal__close");t&&t.addEventListener("click",()=>this.copyCode(this.currentCouponCode,t)),e&&e.addEventListener("click",()=>this.hideLevelCouponModal())}}}function C(t){if(!window.siteRpgData?.restUrl)return;const e=`site_rpg_${t}`,s=localStorage.getItem(e),a=Date.now();if(s&&a-parseInt(s,10)<36e5)return;localStorage.setItem(e,a.toString());const i={"Content-Type":"application/json","X-WP-Nonce":window.siteRpgData.nonce};window.siteRpgData.actionToken&&(i["X-Site-RPG-Token"]=window.siteRpgData.actionToken),fetch(window.siteRpgData.restUrl+"visitor/action",{method:"POST",headers:i,body:JSON.stringify({action:t})}).catch(()=>{})}function k(){document.querySelectorAll(".site-rpg-block").forEach(t=>{t.statRoller=new g(t),window.siteRpgData?.isLoggedIn&&(t.characterManager=new p(t)),t.rewardsManager=new b(t,t.characterManager),"true"===t.dataset.showMiniGame&&new x(t)}),function(){const t=document.querySelectorAll(".site-rpg-card__stat");t.forEach(e=>{let s;e.addEventListener("touchstart",()=>{t.forEach(t=>t.classList.remove("tooltip-active")),e.classList.add("tooltip-active"),clearTimeout(s),s=setTimeout(()=>{e.classList.remove("tooltip-active")},3e3)});const a=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const t=e.querySelector(".site-rpg-card__stat-fill");t&&(t.style.animation="statFillAnimation 1s ease-out forwards"),a.unobserve(e)}})},{threshold:.5});a.observe(e)})}(),document.querySelectorAll("[data-game-highscore]").forEach(t=>{const e=`site_rpg_highscore_${t.dataset.gameHighscore}`,s=localStorage.getItem(e);s&&(t.textContent=`${s} XP`)}),function(){const t=document.querySelectorAll(".site-rpg-card__avatar-particles"),e=["‚ú®","‚≠ê","üí´"];t.forEach(t=>{for(let s=0;s<5;s++){const a=document.createElement("span");a.className="avatar-particle",a.style.setProperty("--delay",.5*s+"s"),a.style.setProperty("--duration",3+2*Math.random()+"s"),a.textContent=e[Math.floor(Math.random()*e.length)],t.appendChild(a)}})}(),C("visit");let t=!1;window.addEventListener("scroll",()=>{t||(window.scrollY+window.innerHeight)/document.body.scrollHeight>.75&&(t=!0,C("scroll"))}),setTimeout(()=>C("time"),12e4)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",k):k()})();